console.log("Starting mukuviewer...");const urlParams=new URLSearchParams(window.location.search),bookId=urlParams.get("book_id")||"00000001";console.log("Book ID:",bookId);var Module={canvas:document.getElementById("viewer-canvas"),print:function(e){console.log("[WASM]",e)},printErr:function(e){console.error("[WASM]",e)},preRun:[function(){console.log("preRun called")}],postRun:[function(){console.log("postRun called"),document.getElementById("loading").style.display="none",console.log("Loading hidden"),setTimeout(()=>{const e=document.getElementById("splash-screen");e.classList.add("fade-out"),setTimeout(()=>{e.style.display="none"},800)},500)}],onRuntimeInitialized:function(){console.log("onRuntimeInitialized called");try{if(Module.ccall){console.log("Calling initialize with bookId:",bookId),Module.ccall("initialize",null,["string"],[bookId]);const e=window.innerWidth>window.innerHeight,t=!e;Module.ccall("setSinglePageMode",null,["boolean"],[t]),console.log("初期表示モード: "+(e?"2ページ（横長）":"1ページ（縦長）"));const o=navigator.userAgent||navigator.vendor||window.opera,l=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile|tablet/i,n="ontouchstart"in window||navigator.maxTouchPoints>0,a=window.innerWidth<=1024;if(l.test(o)||n&&a){const e=document.getElementById("fullscreen-button-fixed");e&&(e.style.display="none",console.log("モバイルデバイスのため全画面ボタンを非表示にしました"));const t=document.getElementById("mode-switch-container");t&&(t.style.right="30px",console.log("モバイルデバイスのためモード切り替えボタンを右端に配置しました"))}window.isMouseOverUIControls=!1,["submenu-open-button","submenu-popup","autoplay-button-fixed","mode-switch-container","fullscreen-button-fixed"].forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("mouseenter",()=>{window.isMouseOverUIControls=!0,clearTimeout(window.uiControlsTimeout)}),t.addEventListener("mouseleave",()=>{window.isMouseOverUIControls=!1,window.uiControlsTimeout=setTimeout(()=>Module.ccall("hideUIControls",null,[],[]),3e3)}))}),document.addEventListener("click",e=>{const t=document.getElementById("submenu-open-button"),o=document.getElementById("submenu-popup");if(t&&t.contains(e.target)||o&&o.contains(e.target))return clearTimeout(window.uiControlsTimeout),void(window.uiControlsTimeout=setTimeout(()=>{window.isMouseOverUIControls||Module.ccall("hideUIControls",null,[],[])},3e3));window.submenuOpen&&o&&(o.classList.remove("visible"),window.submenuOpen=!1),("normal"!==window.viewMode||e.target!==document.getElementById("next-button")&&e.target!==document.getElementById("prev-button"))&&Module.ccall("showUIControls",null,[],[])}),document.addEventListener("touchstart",e=>{const t=document.getElementById("submenu-open-button"),o=document.getElementById("submenu-popup"),l=document.elementFromPoint(e.touches[0].clientX,e.touches[0].clientY);if(t&&t.contains(l)||o&&o.contains(l))return clearTimeout(window.uiControlsTimeout),void(window.uiControlsTimeout=setTimeout(()=>{window.isMouseOverUIControls||Module.ccall("hideUIControls",null,[],[])},3e3));("normal"!==window.viewMode||l!==document.getElementById("next-button")&&l!==document.getElementById("prev-button"))&&Module.ccall("showUIControls",null,[],[])}),document.addEventListener("fullscreenchange",()=>Module.ccall("updateFullscreenIcon",null,[],[])),document.addEventListener("webkitfullscreenchange",()=>Module.ccall("updateFullscreenIcon",null,[],[]))}else console.error("Module.ccall is not available")}catch(e){console.error("Error in onRuntimeInitialized:",e)}},onAbort:function(e){console.error("WASM aborted:",e)}};function nextPage(){console.log("nextPage called");try{Module._nextPage?Module._nextPage():Module.ccall?Module.ccall("nextPage",null,[],[]):console.error("nextPage function not available")}catch(e){console.error("Error in nextPage:",e)}}function prevPage(){console.log("prevPage called");try{Module._prevPage?Module._prevPage():Module.ccall?Module.ccall("prevPage",null,[],[]):console.error("prevPage function not available")}catch(e){console.error("Error in prevPage:",e)}}function showCacheStatus(){Module.ccall&&Module.ccall("printCacheStatus",null,[],[])}window.renderPageToCanvas=function(e,t,o,l,n){const a=document.getElementById(e);if(!a)return void console.error("Canvas not found:",e);const s=a.getContext("2d");if(!s)return void console.error("Failed to get 2d context for canvas:",e);const i=window.devicePixelRatio||1,c=zoomLevel,r=e.includes("vertical");let d,u;if(r){const e=t/o,l=window.innerWidth*c;d=l,u=Math.floor(l/e)}else{const e=t/o;u=window.innerHeight*c,d=Math.floor(u*e)}a.width=Math.floor(d*i),a.height=Math.floor(u*i),a.style.width=d+"px",a.style.height=u+"px",console.log(`Canvas ${e} adjusted to: ${d}x${u} (logical), ${a.width}x${a.height} (physical), dpr: ${i}, scale: ${c}, mode: ${r?"vertical":"horizontal"}`),console.log(`Image size: ${t}x${o}`),s.setTransform(1,0,0,1,0,0),s.scale(i,i);const m=d,g=u;let v;if(s.fillStyle="#000",s.fillRect(0,0,d,u),"undefined"!=typeof HEAPU8)v=HEAPU8;else{if(void 0===Module||!Module.HEAPU8)return void console.error("HEAPU8 is not available");v=Module.HEAPU8}const p=v.subarray(l,l+n),f=new Uint8ClampedArray(p),h=new ImageData(f,t,o),y=document.createElement("canvas");y.width=t,y.height=o;y.getContext("2d").putImageData(h,0,0),s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high",s.drawImage(y,0,0,m,g),console.log("SIZE: "+m+"_"+g),console.log(`Rendered page to canvas ${e}`)};var viewMode="normal";window.viewMode=viewMode;let seamlessDirection="horizontal",seamlessPages=[],verticalPages=[];const MAX_PAGES=20,SEAMLESS_PRELOAD_RANGE=5;let autoplayEnabled=!1,autoplayInterval=null;const AUTOPLAY_SPEED=4,AUTOPLAY_FPS=30;let scrollTimeout,verticalScrollTimeout,uiControlsTimeout,zoomLevel=1,submenuOpen=!1;function isLandscape(){return Module.ccall("isLandscape","boolean",[],[])}function isMobileDevice(){return Module.ccall("isMobileDevice","boolean",[],[])}function toggleSubmenu(){submenuOpen=!submenuOpen;const e=document.getElementById("submenu-popup");submenuOpen?e.classList.add("visible"):e.classList.remove("visible")}function updateSubmenuVisibility(){Module.ccall("updateSubmenuVisibility",null,["string"],[viewMode])}function setZoomLevel(e){if(zoomLevel===e)return;const t=document.getElementById("seamless-container"),o=document.getElementById("vertical-container");zoomLevel=e;const l=document.querySelectorAll("#submenu-zoom-section .submenu-button");l.forEach(e=>{e.classList.remove("active")}),.5===e?(l[0].classList.add("active"),t.classList.add("zoomed"),o.classList.add("zoomed"),console.log("縮小表示を有効化しました (0.5倍)")):1===e?(l[1].classList.add("active"),t.classList.remove("zoomed"),o.classList.remove("zoomed"),console.log("標準表示に設定しました (1倍)")):2===e&&(l[2].classList.add("active"),t.classList.add("zoomed"),o.classList.add("zoomed"),console.log("拡大表示を有効化しました (2倍)")),redrawZoomLevel()}function switchToVertical(){"vertical"!==seamlessDirection&&toggleDirection()}function switchToHorizontal(){"horizontal"!==seamlessDirection&&toggleDirection()}function updateDirectionButtons(){Module.ccall("updateDirectionButtons",null,["string"],[seamlessDirection])}function switchToSeamlessMode(){if("normal"!==viewMode)return;clearTimeout(uiControlsTimeout),uiControlsTimeout=setTimeout(()=>{isMouseOverUIControls||hideUIControls()},UI_CONTROLS_HIDE_DELAY);const e=window.innerWidth>window.innerHeight;seamlessDirection=e?"horizontal":"vertical",viewMode=e?"seamless-horizontal":"seamless-vertical",window.viewMode=viewMode,document.getElementById("normal-mode-content").style.display="none";const t=document.getElementById("autoplay-button-fixed");t.classList.add("visible"),t.classList.add("show"),updateSubmenuVisibility();const o=document.getElementById("submenu-open-button");o&&o.classList.contains("visible")&&o.classList.add("show"),e?(document.getElementById("seamless-container").classList.add("active"),document.getElementById("vertical-container").classList.remove("active"),initSeamlessMode(),console.log("画面が横長のため、横読みモードで開始")):(document.getElementById("seamless-container").classList.remove("active"),document.getElementById("vertical-container").classList.add("active"),initVerticalMode(),console.log("画面が縦長のため、縦読みモードで開始")),updateDirectionButtons(),updateModeSwitchButtons()}function switchToNormalMode(){if("normal"===viewMode)return;clearTimeout(uiControlsTimeout),uiControlsTimeout=setTimeout(()=>{isMouseOverUIControls||hideUIControls()},UI_CONTROLS_HIDE_DELAY),viewMode="normal",window.viewMode=viewMode,document.getElementById("seamless-container").classList.remove("active"),document.getElementById("vertical-container").classList.remove("active"),document.getElementById("normal-mode-content").style.display="block",autoplayEnabled&&toggleAutoplay(),1!==zoomLevel&&setZoomLevel(1);const e=document.getElementById("autoplay-button-fixed");e.classList.remove("visible"),e.classList.remove("show"),updateSubmenuVisibility(),Module.ccall&&Module.ccall("refresh",null,[],[]),updateModeSwitchButtons()}function updateModeSwitchButtons(){Module.ccall("updateModeSwitchButtons",null,["string"],[viewMode]);const e=document.getElementById("seamless-mode-button"),t=document.getElementById("normal-mode-button");"normal"===viewMode?(e.onclick=switchToSeamlessMode,t.onclick=null):(e.onclick=null,t.onclick=switchToNormalMode)}function toggleDirection(){autoplayEnabled&&toggleAutoplay(),"horizontal"===seamlessDirection?(seamlessDirection="vertical",viewMode="seamless-vertical",window.viewMode=viewMode,document.getElementById("seamless-container").classList.remove("active"),document.getElementById("vertical-container").classList.add("active"),initVerticalMode()):(seamlessDirection="horizontal",viewMode="seamless-horizontal",window.viewMode=viewMode,document.getElementById("seamless-container").classList.add("active"),document.getElementById("vertical-container").classList.remove("active"),initSeamlessMode()),updateDirectionButtons()}function initSeamlessMode(){console.log("Initializing seamless horizontal mode...");const e=document.getElementById("seamless-scroll");e.innerHTML="",seamlessPages=[];for(let t=20;t>=1&&t<=20;t--){const o=createPageCanvas(t);e.appendChild(o)}const t=document.getElementById("seamless-container");t.addEventListener("scroll",onSeamlessScroll),setupDragScroll(t),setTimeout(()=>{t.scrollLeft=t.scrollWidth-t.clientWidth,renderVisiblePages()},100)}function initVerticalMode(){console.log("Initializing vertical mode...");const e=document.getElementById("vertical-scroll");e.innerHTML="",verticalPages=[];for(let t=1;t<=20&&t<=20;t++){const o=createVerticalPageCanvas(t);e.appendChild(o)}const t=document.getElementById("vertical-container");t.addEventListener("scroll",onVerticalScroll),setupVerticalDragScroll(t),setTimeout(()=>{t.scrollTop=0,renderVerticalVisiblePages()},100)}function setupDragScroll(e){let t=!1,o=0,l=0,n=0,a=0,s=!1;e.addEventListener("mousedown",i=>{t=!0,o=i.pageX-e.offsetLeft,l=i.pageY-e.offsetTop,n=e.scrollLeft,a=e.scrollTop,e.style.cursor="grabbing",e.style.userSelect="none",e.style.scrollBehavior="auto",console.log(`[Horizontal] Drag start - scrollLeft: ${n}, scrollTop: ${a}, zoomLevel: ${zoomLevel}`),autoplayEnabled&&(s=!0,autoplayInterval&&(clearInterval(autoplayInterval),autoplayInterval=null))}),e.addEventListener("mouseleave",()=>{t=!1,e.style.cursor="grab",e.style.scrollBehavior="smooth"}),e.addEventListener("mouseup",()=>{t=!1,e.style.cursor="grab",e.style.scrollBehavior="smooth",s&&autoplayEnabled&&(s=!1,startHorizontalAutoplay(e))}),e.addEventListener("mousemove",s=>{if(!t)return;s.preventDefault();const i=s.pageX-e.offsetLeft,c=s.pageY-e.offsetTop,r=2*(i-o),d=2*(c-l),u=n-r;if(e.scrollLeft=u,console.log(`[Horizontal] Setting scrollLeft to ${u} (original: ${n}, walkX: ${r})`),1!==zoomLevel){const t=a-d;e.scrollTop=t,console.log(`[Horizontal] Setting scrollTop to ${t} (original: ${a}, walkY: ${d})`)}}),e.addEventListener("touchstart",i=>{t=!0,o=i.touches[0].pageX-e.offsetLeft,l=i.touches[0].pageY-e.offsetTop,n=e.scrollLeft,a=e.scrollTop,autoplayEnabled&&(s=!0,autoplayInterval&&(clearInterval(autoplayInterval),autoplayInterval=null))}),e.addEventListener("touchend",()=>{t=!1,s&&autoplayEnabled&&(s=!1,startHorizontalAutoplay(e))}),e.addEventListener("touchmove",s=>{if(!t)return;const i=s.touches[0].pageX-e.offsetLeft,c=s.touches[0].pageY-e.offsetTop,r=2*(i-o),d=2*(c-l);e.scrollLeft=n-r,1!==zoomLevel&&(e.scrollTop=a-d)}),e.style.cursor="grab"}function createPageCanvas(e){const t=document.getElementById(`page-canvas-${e}`);if(t)return t;const o=document.createElement("canvas");o.id=`page-canvas-${e}`,o.className="page-canvas",o.dataset.pageNum=e,o.dataset.loaded="false";const l=window.devicePixelRatio||1,n=zoomLevel,a=window.innerHeight*n,s=Math.floor(a*(2/3));return o.width=Math.floor(s*l),o.height=Math.floor(a*l),o.style.width=s+"px",o.style.height=a+"px",seamlessPages.push(e),console.log(`Created horizontal canvas for page ${e}, logical: ${s}x${a}, physical: ${o.width}x${o.height}, dpr: ${l}, scale: ${n}`),o}function createVerticalPageCanvas(e){const t=document.getElementById(`vertical-canvas-${e}`);if(t)return t;const o=document.createElement("canvas");o.id=`vertical-canvas-${e}`,o.className="vertical-page-canvas",o.dataset.pageNum=e,o.dataset.loaded="false";const l=window.devicePixelRatio||1,n=zoomLevel,a=window.innerWidth*n,s=Math.floor(1.5*a);return o.width=Math.floor(a*l),o.height=Math.floor(s*l),o.style.width=a+"px",o.style.height=s+"px",verticalPages.push(e),console.log(`Created vertical canvas for page ${e}, logical: ${a}x${s}, physical: ${o.width}x${o.height}, dpr: ${l}, scale: ${n}`),o}function onSeamlessScroll(){clearTimeout(scrollTimeout),scrollTimeout=setTimeout(()=>{loadMorePagesIfNeeded(),renderVisiblePages()},100)}function onVerticalScroll(){clearTimeout(verticalScrollTimeout),verticalScrollTimeout=setTimeout(()=>{loadMoreVerticalPagesIfNeeded(),renderVerticalVisiblePages()},100)}function loadMorePagesIfNeeded(){if(!Module.ccall)return;const e=document.getElementById("seamless-container").getBoundingClientRect(),t=Array.from(document.querySelectorAll(".page-canvas"));let o=20;t.forEach(t=>{if(t.getBoundingClientRect().right>e.left-e.width){const e=parseInt(t.dataset.pageNum);e<o&&(o=e)}});const l=Math.min(...seamlessPages)-1,n=[];for(let e=l;e>Math.max(1,l-10);e--)e>=1&&!document.getElementById(`page-canvas-${e}`)&&n.push(e);n.sort((e,t)=>t-e),n.forEach(e=>{const t=createPageCanvas(e),o=document.getElementById("seamless-scroll"),l=o.firstChild;l?o.insertBefore(t,l):o.appendChild(t),console.log(`Added canvas for page ${e}`),Module.ccall("loadPageToCache",null,["number"],[e])})}function renderVisiblePages(){if(!Module.ccall)return void console.log("Module.ccall not ready");const e=document.getElementById("seamless-container"),t=(e.scrollLeft,e.clientWidth);seamlessPages.forEach(o=>{const l=document.getElementById(`page-canvas-${o}`);if(!l)return;const n=l.getBoundingClientRect(),a=e.getBoundingClientRect();if(n.left<a.right+t&&n.right>a.left-t&&"false"===l.dataset.loaded){console.log(`Loading and rendering page ${o} in seamless mode`),l.dataset.loaded="loading",Module.ccall("loadPageToCache",null,["number"],[o]);let e=0;const t=10,n=()=>{try{Module.ccall("renderSinglePage",null,["number","string"],[o,`page-canvas-${o}`]),l.dataset.loaded="true",console.log(`Successfully rendered page ${o}`)}catch(a){e++,e<t?setTimeout(n,300):(console.error(`Gave up rendering page ${o} after ${t} attempts`),l.dataset.loaded="false")}};setTimeout(n,200)}})}function loadMoreVerticalPagesIfNeeded(){if(!Module.ccall)return;const e=document.getElementById("vertical-container"),t=e.clientHeight;if(e.scrollTop+t>e.scrollHeight-2*t){const e=Math.max(...verticalPages)+1,t=[];for(let o=e;o<e+10&&o<=20;o++)document.getElementById(`vertical-canvas-${o}`)||t.push(o);t.forEach(e=>{const t=createVerticalPageCanvas(e);document.getElementById("vertical-scroll").appendChild(t),console.log(`Added vertical canvas for page ${e}`),Module.ccall("loadPageToCache",null,["number"],[e])})}}function renderVerticalVisiblePages(){if(!Module.ccall)return void console.log("Module.ccall not ready");const e=document.getElementById("vertical-container"),t=e.getBoundingClientRect(),o=e.clientHeight;verticalPages.forEach(e=>{const l=document.getElementById(`vertical-canvas-${e}`);if(!l)return;const n=l.getBoundingClientRect();if(n.top<t.bottom+o&&n.bottom>t.top-o&&"false"===l.dataset.loaded){console.log(`Loading and rendering vertical page ${e}`),l.dataset.loaded="loading",Module.ccall("loadPageToCache",null,["number"],[e]);let t=0;const o=10,n=()=>{try{Module.ccall("renderSinglePage",null,["number","string"],[e,`vertical-canvas-${e}`]),l.dataset.loaded="true",console.log(`Successfully rendered vertical page ${e}`)}catch(a){t++,t<o?setTimeout(n,300):(console.error(`Gave up rendering vertical page ${e} after ${o} attempts`),l.dataset.loaded="false")}};setTimeout(n,200)}})}function setupVerticalDragScroll(e){let t=!1,o=0,l=0,n=0,a=0,s=!1;e.addEventListener("mousedown",i=>{t=!0,o=i.pageX-e.offsetLeft,l=i.pageY-e.offsetTop,n=e.scrollLeft,a=e.scrollTop,e.style.cursor="grabbing",e.style.userSelect="none",e.style.scrollBehavior="auto",console.log(`[Vertical] Drag start - scrollLeft: ${n}, scrollTop: ${a}, zoomLevel: ${zoomLevel}`),autoplayEnabled&&(s=!0,autoplayInterval&&(clearInterval(autoplayInterval),autoplayInterval=null))}),e.addEventListener("mouseleave",()=>{t=!1,e.style.cursor="grab",e.style.scrollBehavior="smooth"}),e.addEventListener("mouseup",()=>{t=!1,e.style.cursor="grab",e.style.scrollBehavior="smooth",s&&autoplayEnabled&&(s=!1,startVerticalAutoplay(e))}),e.addEventListener("mousemove",s=>{if(!t)return;s.preventDefault();const i=s.pageX-e.offsetLeft,c=s.pageY-e.offsetTop,r=2*(i-o),d=2*(c-l),u=a-d;if(e.scrollTop=u,console.log(`[Vertical] Setting scrollTop to ${u} (original: ${a}, walkY: ${d})`),1!==zoomLevel){const t=n-r;e.scrollLeft=t,console.log(`[Vertical] Setting scrollLeft to ${t} (original: ${n}, walkX: ${r})`)}}),e.addEventListener("touchstart",i=>{t=!0,o=i.touches[0].pageX-e.offsetLeft,l=i.touches[0].pageY-e.offsetTop,n=e.scrollLeft,a=e.scrollTop,e.style.scrollBehavior="auto",autoplayEnabled&&(s=!0,autoplayInterval&&(clearInterval(autoplayInterval),autoplayInterval=null))}),e.addEventListener("touchend",()=>{t=!1,e.style.scrollBehavior="smooth",s&&autoplayEnabled&&(s=!1,startVerticalAutoplay(e))}),e.addEventListener("touchmove",s=>{if(!t)return;const i=s.touches[0].pageX-e.offsetLeft,c=s.touches[0].pageY-e.offsetTop,r=2*(i-o),d=a-2*(c-l);if(e.scrollTop=d,1!==zoomLevel){const t=n-r;e.scrollLeft=t}}),e.style.cursor="grab"}function toggleAutoplay(){clearTimeout(uiControlsTimeout),uiControlsTimeout=setTimeout(()=>{isMouseOverUIControls||hideUIControls()},UI_CONTROLS_HIDE_DELAY);const e=document.getElementById("autoplay-button-fixed"),t=e.querySelector("span");if(autoplayEnabled)autoplayEnabled=!1,t.textContent="自動再生",e.classList.remove("playing"),autoplayInterval&&(clearInterval(autoplayInterval),autoplayInterval=null),console.log("自動再生を停止しました");else{if(autoplayEnabled=!0,t.textContent="再生中",e.classList.add("playing"),"horizontal"===seamlessDirection){startHorizontalAutoplay(document.getElementById("seamless-container"))}else{startVerticalAutoplay(document.getElementById("vertical-container"))}console.log("自動再生を開始しました")}}function startHorizontalAutoplay(e){let t=0;autoplayInterval=setInterval(()=>{e.scrollLeft>0?(e.scrollLeft-=4,t++,t%10==0&&(loadMorePagesIfNeeded(),renderVisiblePages())):(console.log("最後のページに到達しました"),toggleAutoplay())},1e3/30)}function startVerticalAutoplay(e){let t=0;autoplayInterval=setInterval(()=>{const o=e.scrollHeight-e.clientHeight;e.scrollTop<o?(e.scrollTop+=4,t++,t%10==0&&(loadMoreVerticalPagesIfNeeded(),renderVerticalVisiblePages())):(console.log("最後のページに到達しました"),toggleAutoplay())},1e3/30)}function redrawZoomLevel(){if("horizontal"===seamlessDirection){document.getElementById("seamless-scroll");const e=document.getElementById("seamless-container").scrollLeft,t=e>0?2===zoomLevel||.5===zoomLevel?1:zoomLevel:1;seamlessPages.forEach(e=>{const t=document.getElementById(`page-canvas-${e}`);t&&(t.dataset.loaded="false")}),recreateHorizontalCanvases(),setTimeout(()=>{const o=document.getElementById("seamless-container"),l=zoomLevel/t;o.scrollLeft=e*l,renderVisiblePages()},100)}else{const e=document.getElementById("vertical-container").scrollTop,t=e>0?2===zoomLevel||.5===zoomLevel?1:zoomLevel:1;verticalPages.forEach(e=>{const t=document.getElementById(`vertical-canvas-${e}`);t&&(t.dataset.loaded="false")}),recreateVerticalCanvases(),setTimeout(()=>{const o=document.getElementById("vertical-container"),l=zoomLevel/t;o.scrollTop=e*l,renderVerticalVisiblePages()},100)}}function recreateHorizontalCanvases(){const e=window.devicePixelRatio||1;[...seamlessPages].forEach(t=>{const o=document.getElementById(`page-canvas-${t}`);if(o){const t=zoomLevel,l=window.innerHeight*t,n=Math.floor(l*(2/3));o.width=Math.floor(n*e),o.height=Math.floor(l*e),o.style.width=n+"px",o.style.height=l+"px",o.dataset.loaded="false"}})}function recreateVerticalCanvases(){const e=window.devicePixelRatio||1;[...verticalPages].forEach(t=>{const o=document.getElementById(`vertical-canvas-${t}`);if(o){const t=zoomLevel,l=window.innerWidth*t,n=Math.floor(1.5*l);o.width=Math.floor(l*e),o.height=Math.floor(n*e),o.style.width=l+"px",o.style.height=n+"px",o.dataset.loaded="false"}})}function toggleFullscreen(){clearTimeout(uiControlsTimeout),uiControlsTimeout=setTimeout(()=>{isMouseOverUIControls||hideUIControls()},UI_CONTROLS_HIDE_DELAY);const e=document.getElementById("container");document.fullscreenElement||document.webkitFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen():e.requestFullscreen?e.requestFullscreen().catch(e=>{console.error("全画面表示に失敗:",e)}):e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}function updateFullscreenIcon(){Module.ccall("updateFullscreenIcon",null,[],[])}let isMouseOverUIControls=!1;const UI_CONTROLS_HIDE_DELAY=3e3;function showUIControls(){Module.ccall("showUIControls",null,[],[])}function hideUIControls(){Module.ccall("hideUIControls",null,[],[])}let navBarTimeout,isMouseOverNavBar=!1;const NAV_BAR_ZONE_HEIGHT=100,NAV_BAR_HIDE_DELAY=3e3,navBar=document.getElementById("nav-bar");function showNavBar(){navBar.classList.remove("hide"),navBar.classList.add("show"),clearTimeout(navBarTimeout),navBarTimeout=setTimeout(()=>{isMouseOverNavBar||hideNavBar()},3e3)}function hideNavBar(){isMouseOverNavBar||(navBar.classList.remove("show"),navBar.classList.add("hide"))}let resizeTimer;navBar.classList.add("hide"),document.addEventListener("mousemove",function(e){const t=window.innerHeight;e.clientY>t-100&&showNavBar()}),navBar.addEventListener("mouseenter",function(){isMouseOverNavBar=!0,clearTimeout(navBarTimeout)}),navBar.addEventListener("mouseleave",function(){isMouseOverNavBar=!1,navBarTimeout=setTimeout(()=>{hideNavBar()},3e3)}),document.addEventListener("keydown",function(e){"ArrowLeft"===e.key?nextPage():"ArrowRight"===e.key?prevPage():"c"!==e.key&&"C"!==e.key||showCacheStatus()}),document.addEventListener("contextmenu",function(e){return e.preventDefault(),!1}),document.addEventListener("dragstart",function(e){return e.preventDefault(),!1}),window.addEventListener("error",function(e){console.error("Script error:",e)});let previousOrientation=window.innerWidth>window.innerHeight;window.addEventListener("resize",function(){clearTimeout(resizeTimer),resizeTimer=setTimeout(function(){console.log("Window resized, re-rendering...");const e=window.innerWidth>window.innerHeight;if("normal"!==viewMode){if(e!==previousOrientation){console.log("画面の向きが変わりました: "+(e?"横長":"縦長"));const t=autoplayEnabled;autoplayEnabled&&toggleAutoplay(),e?"horizontal"!==seamlessDirection&&(seamlessDirection="horizontal",viewMode="seamless-horizontal",window.viewMode=viewMode,document.getElementById("seamless-container").classList.add("active"),document.getElementById("vertical-container").classList.remove("active"),initSeamlessMode(),updateDirectionButtons(),console.log("横読みモードに自動切り替え")):"vertical"!==seamlessDirection&&(seamlessDirection="vertical",viewMode="seamless-vertical",window.viewMode=viewMode,document.getElementById("seamless-container").classList.remove("active"),document.getElementById("vertical-container").classList.add("active"),initVerticalMode(),updateDirectionButtons(),console.log("縦読みモードに自動切り替え")),t&&setTimeout(()=>{toggleAutoplay()},500),previousOrientation=e}}else if("normal"===viewMode)if(e!==previousOrientation&&Module.ccall){const t=!e;console.log(`通常モード: ${e?"2ページ表示（横長）":"1ページ表示（縦長）"}に切り替え`);try{Module.ccall("setSinglePageMode",null,["boolean"],[t])}catch(e){console.error("Error in setSinglePageMode:",e)}previousOrientation=e}else if(Module.ccall)try{Module.ccall("refresh",null,[],[])}catch(e){console.error("Error in resize handler:",e)}},250)});