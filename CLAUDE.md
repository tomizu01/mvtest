# mukuviewer - 開発作業記録

## プロジェクト概要

**アプリ名**: mukuviewer
**説明**: ブラウザで動作する電子コミックビューア
**技術スタック**: C++ + WebAssembly (Emscripten)
**対象環境**: PCブラウザ（将来的にモバイル対応予定）

## 基本仕様

### 起動方法
```
https://mvtest.ci-labo.net/index.html?book_id=[コミックID]
```

### 画像URL形式
```
https://mvtest.ci-labo.net/images/[コミックID]/[ページ番号].jpg.enc
```
- ページ番号は1から始まる
- 最大209ページ（テスト環境）
- 画像はAES-128で暗号化されており、`.enc`拡張子で提供される
- ダウンロード後、C++側で自動的に復号化される

### 表示方式

#### 見開きモード（通常モード）
- **横長画面**: 見開き2ページ表示（右めくり方式）
  - 1ページ目が右側、2ページ目が左側
  - 左右ボタンで2ページずつ移動
- **縦長画面**: 1ページずつ表示
  - 画面いっぱいに1ページを表示
  - 左右ボタンで1ページずつ移動
- アスペクト比を保持しながら画面いっぱいに表示
- 画面の向きが変わると自動的に切り替わる

#### シームレスモード
- **横読みモード**（横長画面で自動選択）
  - 右から左へ横スクロール（20, 19, 18... 2, 1）
  - ドラッグまたは自動再生でスクロール
- **縦読みモード**（縦長画面で自動選択）
  - 上から下へ縦スクロール（1, 2, 3... 20, 21...）
  - 1ページを画面幅いっぱいに表示
  - ドラッグまたは自動再生でスクロール
- 画面の向きが変わると自動的に切り替わる

## 実装済み機能

### 1. コア機能
- [x] WebAssemblyベースのビューア
- [x] JPEG画像の読み込みとデコード（stb_image使用）
- [x] 暗号化画像の復号化対応（AES-128）
  - 画像ダウンロード後、自動的に復号化処理を実行
  - 暗号化キー: `"1234567890123456"`（16バイト固定）
  - PKCS#7パディング方式を使用
- [x] 見開き2ページ表示（横長画面）
- [x] 1ページ表示（縦長画面）
- [x] 画面の向きに応じた自動切り替え
- [x] ページ送り・戻し機能（1ページまたは2ページずつ）
- [x] レスポンシブ表示（ウィンドウサイズに自動適応）

### 2. シームレス表示モード
- [x] 横読みモード
  - 右から左への横スクロール（降順：20, 19, 18... 2, 1）
  - マウス/タッチドラッグでスクロール
  - 動的ページ読み込み（最大209ページ）
  - ビューポートベースの描画最適化
- [x] 縦読みモード
  - 上から下への縦スクロール（昇順：1, 2, 3... 20...）
  - 1ページを画面幅いっぱいに表示
  - マウス/タッチドラッグでスクロール
  - 動的ページ読み込み
- [x] 自動再生機能
  - 横読み：左へ自動スクロール
  - 縦読み：下へ自動スクロール
  - ドラッグ時に一時停止、離すと再開
  - 30fps、4ピクセル/フレーム
- [x] 画面の向きに応じた自動モード選択
  - 横長画面 → 横読みモード
  - 縦長画面 → 縦読みモード
  - ウィンドウリサイズ時の自動切り替え

### 3. 先読み機能（パフォーマンス最適化）
- [x] 現在ページから20ページ先まで先読み（通常モード）
- [x] 優先度ベースの読み込み
  - 即座：現在+4ページ（見開き2回分）
  - 遅延：残り16ページ（100ms後）
- [x] インテリジェントキャッシュ管理
  - 前後15ページまで保持
  - 古いキャッシュは自動削除
- [x] 重複読み込み防止
- [x] シームレスモード用の動的読み込み
  - スクロール位置に応じて次の10ページを自動読み込み
  - ビューポート外のページは未読み込み状態で保持

### 4. UI/UX
- [x] スプラッシュ画面
  - ロゴ画像（public/images/mukuviewer.png）を中央に表示
  - 白背景、パルスアニメーション（拡大縮小）
  - 初期化完了後0.5秒待機してフェードアウト（0.8秒）
- [x] 下部ナビゲーションバー
  - 「シームレス表示」/「見開き表示」切り替えボタン
  - 「横読み」/「縦読み」切り替えボタン（シームレス時のみ表示）
  - 「縮小表示」/「標準表示」切り替えボタン（シームレス時のみ表示）
  - 「拡大表示」/「標準表示」切り替えボタン（シームレス時のみ表示）
  - 「自動再生」/「停止」ボタン（シームレス時のみ表示）
  - 「全画面」ボタン
- [x] ナビゲーションバーの自動表示/非表示
  - デフォルトで非表示、画面をすっきり表示
  - マウスが画面下部100px以内に入ると自動表示
  - 画面のいずれかの場所をクリック/タップで表示（見開きモードでは左右のページ移動ボタン以外）
  - 表示後3秒間操作がないと自動で非表示
  - ナビゲーションバー上にマウスがある間は非表示にならない
  - スムーズなフェードイン/フェードアウト（0.3秒）
- [x] 全画面表示モード
  - 全画面API（webkit, ms プレフィックス対応）
- [x] 左右端のナビゲーションボタン（通常モード）
- [x] キーボードショートカット
  - ← : 次のページ
  - → : 前のページ
  - C : キャッシュステータス表示
- [x] ドラッグスクロール（シームレスモード）
  - 横読み：左右ドラッグ
  - 縦読み：上下ドラッグ
  - タッチイベント対応（モバイル準備完了）
  - 拡大・縮小時は両方向にドラッグスクロール可能
- [x] ウィンドウリサイズ時の自動再描画・モード切り替え
- [x] デバッグ用コンソールログ

### 5. 表示倍率機能（シームレスモード）
- [x] 3段階の表示倍率
  - **縮小表示**: 0.5倍（画像が半分のサイズ）
  - **標準表示**: 1倍（通常サイズ）
  - **拡大表示**: 2倍（2倍のサイズ）
- [x] 縮小表示ボタン
  - シームレスモード時のみ表示
  - クリックで「縮小表示 (0.5倍)」⇔「標準表示 (1倍)」を切り替え
  - 拡大表示がオンの場合は自動的にオフになる
- [x] 拡大表示ボタン
  - シームレスモード時のみ表示
  - クリックで「拡大表示 (2倍)」⇔「標準表示 (1倍)」を切り替え
  - 縮小表示がオンの場合は自動的にオフになる
- [x] 倍率変更時の動作
  - 横読みモード・縦読みモードの両方に対応
  - Canvas要素を動的に再作成してリサイズ
  - スクロール位置を倍率に応じて自動調整
- [x] 縮小表示時の画像配置
  - 横読みモード: 画像を縦方向の中央に配置（align-items: center）
  - 縦読みモード: 通常通り上から配置
- [x] 拡大・縮小時の両方向スクロール
  - 横読みモード + 倍率変更時：横方向と縦方向の両方にスクロール可能
  - 縦読みモード + 倍率変更時：縦方向と横方向の両方にスクロール可能
- [x] スムーズなドラッグスクロール
  - ドラッグ中は scroll-behavior: auto で即座に反映
  - ドラッグ終了時は scroll-behavior: smooth に戻す

## ファイル構成

```
/var/www/mvtest/
├── index.html              # エントリーポイント
├── build.sh                # ビルドスクリプト
├── build/
│   ├── mukuviewer.js       # WebAssemblyラッパー (35KB)
│   └── mukuviewer.wasm     # コンパイル済みバイナリ (120KB)
├── src/
│   ├── main.cpp            # メインのC++ソースコード
│   ├── cipher.cpp          # AES-128暗号化/復号化ライブラリ
│   └── stb_image.h         # 画像デコードライブラリ
├── images/
│   └── 00000001/           # テスト用画像 (1.jpg.enc～209.jpg.enc)
├── public/
│   └── images/
│       └── mukuviewer.png  # ロゴ画像（スプラッシュ画面用）
└── CLAUDE.md               # この開発記録
```

## 主要な技術実装

### ページキャッシュシステム（C++）
```cpp
std::map<int, ImageData> pageCache;  // ページ番号をキーにしたキャッシュ
std::set<int> loadingPages;          // 読み込み中のページ番号
bool singlePageMode;                 // true: 1ページ表示, false: 2ページ表示

static const int PRELOAD_PAGES = 20;  // 先読みするページ数
const int maxPages = 209;             // 最大ページ数
```

### 暗号化/復号化システム（C++ - cipher.cpp）
```cpp
// AES-128暗号化/復号化の実装
uint8_t crypt_key[] = "1234567890123456";  // 16バイト固定キー

// 復号化関数（main.cppから呼び出される）
int invCipher(uint8_t* data, int size);

// 主要なAES-128関数
void invCipher16(uint8_t* data, uint8_t* key);  // 16バイトブロック復号化
void KeyExpansion(uint8_t *key);                // 鍵スケジュール
void invSubBytes(uint8_t* src);                 // S-Box逆変換
void invShiftRows(uint8_t* src);                // 行シフト逆変換
void invMixColumns(uint8_t* src);               // 列混合逆変換
void AddRoundKey(uint8_t* src, uint8_t nRound); // ラウンドキー加算
```

**実装の特徴**:
- AES-128アルゴリズム（128ビット鍵、10ラウンド）
- PKCS#7パディング方式を使用
- 16バイト（128ビット）ブロック暗号
- 暗号化されたデータは、復号化後に元のJPEG形式に戻る
- 復号化はダウンロード直後、画像デコード前に実行される（src/main.cpp:141-142）

### 画面の向き判定（JavaScript）
```javascript
function isLandscape() {
    return window.innerWidth > window.innerHeight;
}

// 初期化時
const landscape = isLandscape();
const singlePage = !landscape; // 縦長の場合は1ページモード
Module.ccall('setSinglePageMode', null, ['boolean'], [singlePage]);

// リサイズ時
window.addEventListener('resize', function() {
    const currentOrientation = isLandscape();
    if (currentOrientation !== previousOrientation) {
        // モードを自動切り替え
    }
});
```

### 画像デコードフロー
1. `emscripten_fetch` で暗号化画像（.jpg.enc）をダウンロード
2. `invCipher()` でAES-128復号化を実行してJPEGデータを取得
3. `stbi_load_from_memory` でJPEGをRGBAにデコード
4. C++の`std::vector`にデータ保存
5. JavaScript側で`ImageData`オブジェクトに変換
6. Canvasに描画

### 描画最適化

#### 通常モード（見開き表示）
- 1ページ/2ページモードの自動切り替え
- アスペクト比計算により画面サイズに最適化
- 一時Canvasを使用して高品質リサイズ
- 見開き2ページの幅比率を保持

#### シームレスモード
- 各ページを個別のCanvas要素として生成
- ビューポート内のページのみ描画（パフォーマンス最適化）
- スクロール位置に応じた遅延読み込み
- 横読み：Flexbox横並び（right-to-left order）
- 縦読み：Flexbox縦並び（1ページ/行）

## ビルド方法

```bash
cd /var/www/mvtest
./build.sh
```

**ビルド設定**:
- Emscripten 4.0.18
- 最適化レベル: -O2
- WASM=1, FETCH=1（非同期HTTP取得）
- ALLOW_MEMORY_GROWTH=1（動的メモリ拡張）

## 開発中に解決した問題

### 1. Module重複宣言エラー
**問題**: `let Module`がEmscriptenコードと競合
**解決**: `var Module`に変更

### 2. HEAPU8.bufferアクセスエラー
**問題**: `Module.HEAPU8.buffer`が未定義
**解決**: `HEAPU8.subarray()`を使用してコピー作成

### 3. 画像サイズが小さい
**問題**: 画像がCanvas内で小さく表示される
**解決**: アスペクト比保持しながら画面いっぱいに拡大表示

### 4. ページめくりが遅い
**問題**: 先読み処理が20ページ一度にリクエストしUIブロック
**解決**: 優先度ベースの段階的読み込み（即座4ページ + 遅延16ページ）

### 5. シームレスモードでページの順序が逆
**問題**: ページが左から右（1, 2, 3...）で並んでいた
**解決**: ループを逆順（20, 19, 18...）に変更し、右から左の配置を実現

### 6. ドラッグ方向が逆
**問題**: 左ドラッグでページが戻り、右ドラッグで進んでいた
**解決**: `scrollLeft + walk` を `scrollLeft - walk` に変更

### 7. ページ間の間隔が広い
**問題**: ページとページの間に大きな空白ができていた
**解決**: `min-width: 50vw` を削除し、画像のアスペクト比に基づいてCanvas幅を動的計算

### 8. 自動再生中にページが読み込まれない
**問題**: 自動スクロール中、未読み込みページに到達すると黒画面になる
**解決**: 自動再生中も10フレームごとに `loadMorePagesIfNeeded()` と `renderVisiblePages()` を呼び出す

### 9. 拡大表示時にドラッグスクロールが効かない
**問題**: 拡大表示時にドラッグでスクロールしようとしても画面が動かない
**解決**: `scroll-behavior: smooth` がドラッグと干渉していたため、ドラッグ開始時に `auto` に変更し、ドラッグ終了時に `smooth` に戻す処理を追加

### 10. 変数スコープの競合
**問題**: `setupDragScroll`関数の変数がグローバルスコープになっており、横読み・縦読みモードで競合
**解決**: すべての変数を関数内のローカル変数に変更

### 11. 縮小表示時の画像配置が上寄せになる
**問題**: 縮小表示（0.5倍）にした際、横読みモードで画像が画面上部に寄ってしまい見づらい
**解決**: `#seamless-scroll`に`align-items: center`を追加して縦方向中央に配置

## パフォーマンス

### メモリ使用量
- 1ページあたり: 約3.84MB (800x1200x4バイト)
- キャッシュ最大: 約58MB (15ページ分)
- 実測: 先読み20ページで約77MB

### 読み込み速度
- キャッシュヒット時: 即座（<10ms）
- ネットワーク読み込み: 画像サイズ依存（テスト画像は30KB程度）

## 今後の課題・改善案

### 短期的改善
- [ ] ローディングインジケーターの追加
- [ ] ページ番号表示UI（現在ページ / 総ページ数）
- [ ] エラーハンドリングの強化（404時など）
- [ ] 自動再生速度の調整機能
- [ ] ページジャンプ機能（特定ページに直接移動）

### 中期的改善
- [ ] ページ総数の動的取得（現在は固定209ページ）
- [ ] ブックマーク機能（読んだページを記憶）
- [ ] 画像圧縮最適化（WebP対応検討）
- [ ] プリロード範囲の調整機能
- [ ] UIテーマのカスタマイズ

### 長期的改善
- [ ] 複数のコミックを管理するライブラリ機能
- [ ] オフライン対応（Service Worker + IndexedDB）
- [ ] PDF出力機能
- [ ] 読書履歴の記録・分析
- [ ] コメント・メモ機能

## デバッグ方法

### ブラウザコンソールでの確認
```javascript
// キャッシュ状態を表示
Module.ccall('printCacheStatus', null, [], []);

// 手動で次ページへ
Module.ccall('nextPage', null, [], []);

// 画面を再描画
Module.ccall('refresh', null, [], []);

// 1ページ/2ページモードの切り替え
Module.ccall('setSinglePageMode', null, ['boolean'], [true]);  // 1ページモード
Module.ccall('setSinglePageMode', null, ['boolean'], [false]); // 2ページモード

// 特定ページをキャッシュに読み込み
Module.ccall('loadPageToCache', null, ['number'], [50]);

// 単一ページを描画（シームレスモード用）
Module.ccall('renderSinglePage', null, ['number', 'string'], [1, 'page-canvas-1']);
```

### よく使うログ

#### 通常モード
```
[WASM] Initialized viewer with book_id: 00000001
[WASM] Single page mode: OFF
[WASM] Loading pages 1 and 2
[WASM] Fetching: https://mvtest.ci-labo.net/images/00000001/1.jpg.enc
[WASM] Fetch success: [暗号化ファイルサイズ] bytes
[WASM] Image decoded (page 1): 800x1200, channels: 3
[WASM] Rendering pages 1 and 2...
[WASM] Preloading pages from 1 to 21
```

#### シームレスモード
```
Initializing seamless horizontal mode...
Created horizontal canvas for page 20, size: 533x800
画面が横長のため、横読みモードで開始
Loading and rendering page 20 in seamless mode
Successfully rendered page 20
```

#### 画面の向き切り替え
```
Window resized, re-rendering...
画面の向きが変わりました: 縦長
縦読みモードに自動切り替え
Initializing vertical mode...
Created vertical canvas for page 1, size: 1920x2880
```

## 依存関係

### システム要件
- Emscripten SDK (emsdk)
- libatomic (Amazon Linux 2023)
- ImageMagick (テスト画像生成用)

### ライブラリ
- stb_image.h (v2.x) - パブリックドメイン（画像デコード用）
- cipher.cpp - 自作AES-128暗号化/復号化ライブラリ（暗号化画像対応用）

## メモ

### Emscripten環境
- インストール先: `~/emsdk`
- 有効化: `source ~/emsdk/emsdk_env.sh`
- バージョン: 4.0.18

### テスト画像生成
```bash
cd /var/www/mvtest/images/00000001
for i in {1..15}; do
  convert -size 800x1200 -background white -fill black \
  -pointsize 200 -gravity center label:"Page $i" $i.jpg
done
```

### 既存の画像ファイル
- 1.jpg～209.jpg が既に存在（別途生成済み）
- サイズは様々（30KB～4.3MB）

## 最終更新

- **日付**: 2025-11-07
- **最終ビルド**: mukuviewer.js (36KB), mukuviewer.wasm (121KB)
- **作業状況**: 暗号化画像の復号化対応完了

### 本セッションで実装した機能
1. **暗号化画像の復号化対応**
   - src/cipher.cppを追加（AES-128暗号化/復号化ライブラリ）
   - build.shを更新してcipher.cppをコンパイル対象に追加
   - 画像URLを`.jpg.enc`に変更（暗号化画像を取得）
   - ダウンロード後に`invCipher()`関数で自動的に復号化
   - 暗号化アルゴリズム: AES-128（128ビット鍵、10ラウンド、PKCS#7パディング）
   - 暗号化キー: `"1234567890123456"`（16バイト固定）
   - 復号化処理はstb_imageによる画像デコードの前に実行される

### 過去のセッションで実装した機能
1. **縮小表示機能（シームレスモード）**
   - 縮小表示ボタンの追加（シームレス時のみ表示）
   - 3段階の表示倍率に対応（縮小0.5倍、標準1倍、拡大2倍）
   - 縮小・拡大表示ボタンは排他的に動作（片方をオンにすると他方は自動オフ）
   - 横読みモード・縦読みモードの両方に対応
   - 縮小・拡大時は両方向にドラッグスクロール可能
     - 横読みモード + 倍率変更時：横方向と縦方向の両方にスクロール
     - 縦読みモード + 倍率変更時：縦方向と横方向の両方にスクロール
   - 縮小表示時の画像配置を縦方向中央に（横読みモード）

2. **ナビゲーションバーの自動表示/非表示**
   - デフォルトで非表示（画面をすっきり表示）
   - マウスが画面下部100px以内に入ると自動表示
   - 画面下部100px以内をクリック/タップで表示（モバイル対応）
   - 表示後3秒間操作がないと自動で非表示
   - ナビゲーションバー上にマウスがある間は非表示にならない
   - スムーズなフェードイン/フェードアウトアニメーション（0.3秒）

3. **技術的改善**
   - `zoomEnabled`（boolean）を`zoomLevel`（数値）に変更し、柔軟な倍率管理を実現
   - スクロール位置を倍率変更時に自動調整する処理を改善
   - Canvas要素のサイズを倍率に応じて動的に再計算
   - Flexboxの`align-items: center`を使用して縮小時の画像を中央配置

### エクスポート関数（C++）
- `initialize(book_id)` - 初期化
- `nextPage()` - 次ページへ
- `prevPage()` - 前ページへ
- `refresh()` - 再描画
- `printCacheStatus()` - キャッシュ状態表示
- `preloadPagesDelayed()` - 遅延先読み
- `renderSinglePage(pageNum, canvasId)` - 単一ページ描画
- `loadPageToCache(pageNum)` - ページをキャッシュに読み込み
- `setSinglePageMode(enabled)` - 1ページ/2ページモード切り替え

## 連絡事項

### 確認すべき項目
1. ✅ ページめくりの体感速度が改善されたか → 先読み機能で改善
2. ✅ 先読みがUIをブロックしていないか → 優先度ベースの読み込みで解決
3. ✅ メモリ使用量が許容範囲か → キャッシュ管理で最適化
4. ✅ 縦読み/横読みモードの実装 → 完了
5. ✅ 画面の向きに応じた自動切り替え → 完了
6. ✅ スプラッシュ画面の追加 → 完了
7. ✅ 拡大表示機能の実装 → 完了
8. ✅ 縮小表示機能の実装 → 完了（0.5倍表示対応）
9. ✅ ナビゲーションバーの自動表示/非表示 → 完了

### 次のステップ候補
- ページ番号表示UIの追加
- 自動再生速度の調整機能
- ページジャンプ機能
- ローディングインジケーター
- より多段階の倍率選択（0.25倍、0.75倍、1.5倍など）
- デバッグログの削除（本番環境用）
- ページ履歴の保存（LocalStorage利用）
