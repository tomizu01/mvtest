<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mukuviewer - Comic Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #222;
            font-family: sans-serif;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #viewer-canvas {
            background-color: #000;
            width: 100%;
            height: 100%;
            object-fit: contain;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            /* 高品質な画像レンダリングを指定（スムーズな補間） */
            image-rendering: auto;
            image-rendering: smooth;
        }

        .nav-button {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 80px;
            background-color: rgba(255, 255, 255, 0.05);
            border: none;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.5);
            font-size: 48px;
            transition: background-color 0.2s;
            z-index: 10;
        }

        .nav-button:hover {
            background-color: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.8);
        }

        .nav-button:active {
            background-color: rgba(255, 255, 255, 0.25);
        }

        #prev-button {
            right: 0;
        }

        #next-button {
            left: 0;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
        }

        /* ナビゲーションバー */
        #nav-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0));
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            z-index: 20;
            transition: opacity 0.3s;
        }

        #nav-bar.hide {
            opacity: 0;
            pointer-events: none;
        }

        #nav-bar.show {
            opacity: 1;
            pointer-events: auto;
        }

        .nav-bar-button {
            padding: 10px 20px;
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .nav-bar-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .nav-bar-button:active {
            background-color: rgba(255, 255, 255, 0.4);
        }

        /* シームレスモード用のスタイル（横読み） */
        #seamless-container {
            display: none;
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        #seamless-container.active {
            display: block;
        }

        /* 拡大表示時は縦方向もスクロール可能に */
        #seamless-container.zoomed {
            overflow-y: auto;
        }

        #seamless-scroll {
            display: flex;
            align-items: center;
            height: 100%;
            width: fit-content;
        }

        .page-canvas {
            height: 100vh;
            flex-shrink: 0;
            background-color: #111;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            /* 高品質な画像レンダリングを指定（スムーズな補間） */
            image-rendering: auto;
            image-rendering: smooth;
        }

        /* 縦読みモード用のスタイル */
        #vertical-container {
            display: none;
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        #vertical-container.active {
            display: block;
        }

        /* 拡大表示時は横方向もスクロール可能に */
        #vertical-container.zoomed {
            overflow-x: auto;
        }

        #vertical-scroll {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: fit-content;
        }

        .vertical-page-canvas {
            width: 100vw;
            flex-shrink: 0;
            background-color: #111;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            /* 高品質な画像レンダリングを指定（スムーズな補間） */
            image-rendering: auto;
            image-rendering: smooth;
        }

        /* 通常モードのコンテナ */
        #normal-mode-content {
            position: relative;
            width: 100%;
            height: 100%;
        }

        #container.seamless-mode #normal-mode-content {
            display: none;
        }

        /* スプラッシュ画面 */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.8s ease-out;
        }

        #splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        #splash-logo {
            max-width: 80%;
            max-height: 80%;
            object-fit: contain;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.8;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
        }

        /* サブメニューオープンボタン */
        #submenu-open-button {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 30;
            display: none;
            padding: 0;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        #submenu-open-button.visible {
            display: block;
        }

        #submenu-open-button.show {
            opacity: 0.8;
            pointer-events: auto;
        }

        #submenu-open-button:hover {
            opacity: 1;
        }

        #submenu-open-button img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* サブメニューポップアップ */
        #submenu-popup {
            position: fixed;
            top: 70px;
            right: 20px;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            z-index: 25;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        #submenu-popup.visible {
            display: block;
        }

        .submenu-section {
            margin-bottom: 15px;
        }

        .submenu-section:last-child {
            margin-bottom: 0;
        }

        .submenu-section-title {
            color: #464646;
            font-size: 12px;
            margin-bottom: 8px;
            padding-left: 2px;
            font-weight: 500;
        }

        .submenu-button-group {
            display: flex;
            gap: 8px;
        }

        .submenu-button {
            flex: 1;
            min-width: 0;
            padding: 10px 12px;
            background-color: #f5f5f5;
            border: 1px solid #d0d0d0;
            border-radius: 5px;
            color: #464646;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .submenu-button-group .submenu-button {
            flex: 1 1 0;
        }

        .submenu-button:hover {
            background-color: #e8e8e8;
            border-color: #b0b0b0;
        }

        .submenu-button:active {
            background-color: #e0e0e0;
        }

        .submenu-button.active {
            background-color: #e3f2fd;
            border-color: #396BD6;
            color: #396BD6;
            font-weight: 500;
        }

        .submenu-button img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .submenu-button .icon-off {
            display: inline-block;
        }

        .submenu-button .icon-on {
            display: none;
        }

        .submenu-button.active .icon-off {
            display: none;
        }

        .submenu-button.active .icon-on {
            display: inline-block;
        }

        /* 自動再生ボタン（左下固定） */
        #autoplay-button-fixed {
            position: fixed;
            bottom: 30px;
            left: 30px;
            padding: 12px 24px;
            background-color: #333;
            border: 2px solid #333;
            border-radius: 25px;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            z-index: 20;
            display: none;
            opacity: 0;
            transition: opacity 0.3s, background-color 0.2s, border-color 0.2s, box-shadow 0.2s, transform 0.1s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            align-items: center;
            gap: 8px;
            pointer-events: none;
        }

        #autoplay-button-fixed.visible {
            display: flex;
        }

        #autoplay-button-fixed.show {
            opacity: 1;
            pointer-events: auto;
        }

        #autoplay-button-fixed:hover {
            background-color: #000;
            border-color: #000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        #autoplay-button-fixed:active {
            transform: scale(0.98);
        }

        #autoplay-button-fixed img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        #autoplay-button-fixed .play-start {
            display: inline-block;
        }

        #autoplay-button-fixed .play-stop {
            display: none;
        }

        #autoplay-button-fixed.playing .play-start {
            display: none;
        }

        #autoplay-button-fixed.playing .play-stop {
            display: inline-block;
        }

        /* モード切り替えボタン（見開き/シームレス） */
        #mode-switch-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #ffffff;
            border-radius: 25px;
            padding: 8px;
            display: flex;
            gap: 4px;
            z-index: 20;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        #mode-switch-container.show {
            opacity: 1;
            pointer-events: auto;
        }

        .mode-switch-button {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
        }

        .mode-switch-button img {
            display: block;
            height: 40px;
            width: auto;
        }

        .mode-switch-button:hover:not(.inactive) {
            opacity: 0.8;
        }

        .mode-switch-button:active:not(.inactive) {
            transform: scale(0.95);
        }

        .mode-switch-button.inactive {
            cursor: default;
            opacity: 0.6;
        }

        /* 全画面表示ボタン（右下固定） */
        #fullscreen-button-fixed {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            z-index: 20;
            opacity: 0;
            transition: opacity 0.3s, transform 0.1s;
            pointer-events: none;
        }

        #fullscreen-button-fixed.show {
            opacity: 1;
            pointer-events: auto;
        }

        #fullscreen-button-fixed:hover {
            opacity: 0.8;
        }

        #fullscreen-button-fixed:active {
            transform: scale(0.95);
        }

        #fullscreen-button-fixed img {
            display: block;
            height: 40px;
            width: auto;
        }

        /* モード切り替えボタンを全画面ボタンの左に配置 */
        #mode-switch-container {
            right: 150px; /* 全画面ボタン(幅約40px) + 余白(100px) */
        }

        /* モバイルデバイス向けのスタイル調整（画面幅に対して相対的なサイズ） */
        @media screen and (max-width: 768px) {
            /* サブメニューオープンボタン */
            #submenu-open-button {
                top: 2vw;
                right: 2vw;
                width: 10vw;
                height: 10vw;
                max-width: 50px;
                max-height: 50px;
            }

            /* サブメニューポップアップの位置調整 */
            #submenu-popup {
                top: 13vw;
                right: 2vw;
                padding: 3vw;
                max-width: 90vw;
            }

            .submenu-section-title {
                font-size: 2.8vw;
            }

            .submenu-button {
                padding: 2vw 2.5vw;
                font-size: 3vw;
            }

            .submenu-button img {
                width: 4.5vw;
                height: 4.5vw;
                max-width: 22px;
                max-height: 22px;
            }

            /* 自動再生ボタン */
            #autoplay-button-fixed {
                bottom: 3vw;
                left: 3vw;
                padding: 2vw 4vw;
                font-size: 3vw;
                border-radius: 5vw;
            }

            #autoplay-button-fixed img {
                width: 4vw;
                height: 4vw;
                max-width: 20px;
                max-height: 20px;
            }

            /* モード切り替えボタン */
            #mode-switch-container {
                bottom: 3vw;
                right: 3vw;
                padding: 1.5vw;
                border-radius: 5vw;
                gap: 1vw;
            }

            .mode-switch-button img {
                height: 8vw;
                max-height: 40px;
            }

            /* 全画面ボタン */
            #fullscreen-button-fixed {
                bottom: 3vw;
                right: 3vw;
            }

            #fullscreen-button-fixed img {
                height: 8vw;
                max-height: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- スプラッシュ画面 -->
    <div id="splash-screen">
        <img id="splash-logo" src="public/images/mukuviewer.png" alt="mukuviewer">
    </div>

    <div id="container">
        <div id="loading">Loading...</div>

        <!-- 通常モード（見開き表示） -->
        <div id="normal-mode-content">
            <canvas id="viewer-canvas"></canvas>
            <button id="next-button" class="nav-button" onclick="nextPage()">❮</button>
            <button id="prev-button" class="nav-button" onclick="prevPage()">❯</button>
        </div>

        <!-- シームレスモード（横スクロール） -->
        <div id="seamless-container">
            <div id="seamless-scroll"></div>
        </div>

        <!-- 縦読みモード（縦スクロール） -->
        <div id="vertical-container">
            <div id="vertical-scroll"></div>
        </div>

        <!-- ナビゲーションバー -->
        <div id="nav-bar" style="display: none;">
        </div>

        <!-- 自動再生ボタン（左下固定） -->
        <button id="autoplay-button-fixed" onclick="toggleAutoplay()">
            <img class="play-start" src="public/images/play_start.png" alt="">
            <img class="play-stop" src="public/images/play_stop.png" alt="">
            <span>自動再生</span>
        </button>

        <!-- モード切り替えボタン（全画面ボタンの左） -->
        <div id="mode-switch-container">
            <button id="seamless-mode-button" class="mode-switch-button" onclick="switchToSeamlessMode()">
                <img id="seamless-mode-icon" src="public/images/button_seamless_off.png" alt="シームレス表示">
            </button>
            <button id="normal-mode-button" class="mode-switch-button inactive">
                <img id="normal-mode-icon" src="public/images/button_mihiraki_on.png" alt="見開き表示">
            </button>
        </div>

        <!-- 全画面表示ボタン（右下固定） -->
        <button id="fullscreen-button-fixed" onclick="toggleFullscreen()">
            <img id="fullscreen-icon" src="public/images/fullscreen.png" alt="全画面">
        </button>

        <!-- サブメニューオープンボタン -->
        <button id="submenu-open-button" onclick="toggleSubmenu()">
            <img src="public/images/submenu_open.png" alt="メニュー">
        </button>

        <!-- サブメニューポップアップ -->
        <div id="submenu-popup">
            <!-- ズームセクション -->
            <div class="submenu-section" id="submenu-zoom-section">
                <div class="submenu-section-title">ズーム</div>
                <div class="submenu-button-group">
                    <button class="submenu-button" onclick="setZoomLevel(0.5)">
                        <img class="icon-off" src="public/images/reduce_off.png" alt="">
                        <img class="icon-on" src="public/images/reduce_on.png" alt="">
                        <span>縮小</span>
                    </button>
                    <button class="submenu-button active" onclick="setZoomLevel(1)">
                        <span>標準</span>
                    </button>
                    <button class="submenu-button" onclick="setZoomLevel(2)">
                        <img class="icon-off" src="public/images/enlarge_off.png" alt="">
                        <img class="icon-on" src="public/images/enlarge_on.png" alt="">
                        <span>拡大</span>
                    </button>
                </div>
            </div>

            <!-- 読み方向セクション -->
            <div class="submenu-section" id="submenu-direction-section">
                <div class="submenu-section-title">読み方向</div>
                <div class="submenu-button-group">
                    <button class="submenu-button" id="submenu-vertical-button" onclick="switchToVertical()">
                        <img class="icon-off" src="public/images/tate_off.png" alt="">
                        <img class="icon-on" src="public/images/tate_on.png" alt="">
                        <span>縦読み</span>
                    </button>
                    <button class="submenu-button" id="submenu-horizontal-button" onclick="switchToHorizontal()">
                        <img class="icon-off" src="public/images/yoko_off.png" alt="">
                        <img class="icon-on" src="public/images/yoko_on.png" alt="">
                        <span>横読み</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('Starting mukuviewer...');

        // URLからbook_idを取得
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('book_id') || '00000001';
        console.log('Book ID:', bookId);

        // グローバル変数（Emscriptenが拡張する）
        var Module = {
            canvas: document.getElementById('viewer-canvas'),
            print: function(text) {
                console.log('[WASM]', text);
            },
            printErr: function(text) {
                console.error('[WASM]', text);
            },
            preRun: [function() {
                console.log('preRun called');
            }],
            postRun: [function() {
                console.log('postRun called');
                document.getElementById('loading').style.display = 'none';
                console.log('Loading hidden');

                // スプラッシュ画面をフェードアウト
                setTimeout(() => {
                    const splashScreen = document.getElementById('splash-screen');
                    splashScreen.classList.add('fade-out');
                    // フェードアウト完了後に要素を削除
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                    }, 800);
                }, 500); // 0.5秒後にフェードアウト開始
            }],
            onRuntimeInitialized: function() {
                console.log('onRuntimeInitialized called');
                try {
                    if (Module.ccall) {
                        console.log('Calling initialize with bookId:', bookId);
                        Module.ccall('initialize', null, ['string'], [bookId]);

                        // 画面の向きに応じて1ページモード/2ページモードを設定
                        const landscape = isLandscape();
                        const singlePage = !landscape; // 縦長の場合は1ページモード
                        Module.ccall('setSinglePageMode', null, ['boolean'], [singlePage]);
                        console.log(`初期表示モード: ${landscape ? '2ページ（横長）' : '1ページ（縦長）'}`);

                        // モバイルデバイスの場合は全画面ボタンを非表示、モード切り替えボタンを右端に移動
                        if (isMobileDevice()) {
                            const fullscreenButton = document.getElementById('fullscreen-button-fixed');
                            if (fullscreenButton) {
                                fullscreenButton.style.display = 'none';
                                console.log('モバイルデバイスのため全画面ボタンを非表示にしました');
                            }

                            const modeSwitchContainer = document.getElementById('mode-switch-container');
                            if (modeSwitchContainer) {
                                modeSwitchContainer.style.right = '30px';
                                console.log('モバイルデバイスのためモード切り替えボタンを右端に配置しました');
                            }
                        }
                    } else {
                        console.error('Module.ccall is not available');
                    }
                } catch (e) {
                    console.error('Error in onRuntimeInitialized:', e);
                }
            },
            onAbort: function(what) {
                console.error('WASM aborted:', what);
            }
        };

        // ページ送り関数
        function nextPage() {
            console.log('nextPage called');
            try {
                if (Module._nextPage) {
                    Module._nextPage();
                } else if (Module.ccall) {
                    Module.ccall('nextPage', null, [], []);
                } else {
                    console.error('nextPage function not available');
                }
            } catch (e) {
                console.error('Error in nextPage:', e);
            }
        }

        function prevPage() {
            console.log('prevPage called');
            try {
                if (Module._prevPage) {
                    Module._prevPage();
                } else if (Module.ccall) {
                    Module.ccall('prevPage', null, [], []);
                } else {
                    console.error('prevPage function not available');
                }
            } catch (e) {
                console.error('Error in prevPage:', e);
            }
        }

        // キャッシュステータスを表示（デバッグ用）
        function showCacheStatus() {
            if (Module.ccall) {
                Module.ccall('printCacheStatus', null, [], []);
            }
        }

        // C++から呼ばれるページ描画関数
        window.renderPageToCanvas = function(canvasId, imgWidth, imgHeight, dataPtr, dataSize) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error('Canvas not found:', canvasId);
                return;
            }

            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('Failed to get 2d context for canvas:', canvasId);
                return;
            }

            // デバイスピクセル比を取得
            const dpr = window.devicePixelRatio || 1;

            // 表示倍率を適用
            const scale = zoomLevel;

            // 縦読みモードか横読みモードかを判定
            const isVerticalMode = canvasId.includes('vertical');

            let optimalWidth, canvasHeight;

            if (isVerticalMode) {
                // 縦読みモード：画面幅を基準にサイズを計算（論理サイズ）
                const imageAspect = imgWidth / imgHeight;
                const canvasWidth = window.innerWidth * scale;
                const optimalHeight = Math.floor(canvasWidth / imageAspect);

                optimalWidth = canvasWidth;
                canvasHeight = optimalHeight;
            } else {
                // 横読みモード：画面高さを基準にサイズを計算（論理サイズ）
                const imageAspect = imgWidth / imgHeight;
                canvasHeight = window.innerHeight * scale;
                optimalWidth = Math.floor(canvasHeight * imageAspect);
            }

            // Canvasの描画バッファサイズを物理ピクセルで設定（高DPI対応）
            canvas.width = Math.floor(optimalWidth * dpr);
            canvas.height = Math.floor(canvasHeight * dpr);
            // CSSサイズは論理ピクセルで設定
            canvas.style.width = optimalWidth + 'px';
            canvas.style.height = canvasHeight + 'px';

            console.log(`Canvas ${canvasId} adjusted to: ${optimalWidth}x${canvasHeight} (logical), ${canvas.width}x${canvas.height} (physical), dpr: ${dpr}, scale: ${scale}, mode: ${isVerticalMode ? 'vertical' : 'horizontal'}`);
            console.log(`Image size: ${imgWidth}x${imgHeight}`);

            // コンテキストをデバイスピクセル比でスケーリング
            ctx.setTransform(1, 0, 0, 1, 0, 0); // リセット
            ctx.scale(dpr, dpr);

            // 画像を画面いっぱいに描画（アスペクト比維持）- 論理座標系で指定
            const displayWidth = optimalWidth;
            const displayHeight = canvasHeight;

            // 背景をクリア
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, optimalWidth, canvasHeight);

            // メモリからデータを取得
            let heap;
            if (typeof HEAPU8 !== 'undefined') {
                heap = HEAPU8;
            } else if (typeof Module !== 'undefined' && Module.HEAPU8) {
                heap = Module.HEAPU8;
            } else {
                console.error('HEAPU8 is not available');
                return;
            }

            const srcData = heap.subarray(dataPtr, dataPtr + dataSize);
            const data = new Uint8ClampedArray(srcData);
            const imageData = new ImageData(data, imgWidth, imgHeight);

            // 一時的なCanvasを作成して画像を描画
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = imgWidth;
            tempCanvas.height = imgHeight;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.putImageData(imageData, 0, 0);

            // 高品質な画像描画設定
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            // メインCanvasいっぱいに描画（論理座標系で指定）
            ctx.drawImage(tempCanvas, 0, 0, displayWidth, displayHeight);

            console.log("SIZE: " + displayWidth + "_" + displayHeight );

            console.log(`Rendered page to canvas ${canvasId}`);
        };

        // 表示モードの管理
        let viewMode = 'normal'; // 'normal', 'seamless-horizontal', 'seamless-vertical'
        let seamlessDirection = 'horizontal'; // 'horizontal' or 'vertical'
        let seamlessPages = [];
        let verticalPages = [];
        const MAX_PAGES = 20; // デモ版の最大ページ数
        const SEAMLESS_PRELOAD_RANGE = 5; // 現在位置から前後5ページを読み込む

        // 自動再生の管理
        let autoplayEnabled = false;
        let autoplayInterval = null;
        const AUTOPLAY_SPEED = 4; // 1フレームあたりのスクロール量（ピクセル）
        const AUTOPLAY_FPS = 30; // フレームレート

        // 表示倍率の管理
        let zoomLevel = 1; // 0.5: 縮小表示, 1: 標準表示, 2: 拡大表示

        // サブメニューの管理
        let submenuOpen = false;

        // 画面が横長かどうかを判定
        function isLandscape() {
            return window.innerWidth > window.innerHeight;
        }

        // モバイルデバイスかどうかを判定
        function isMobileDevice() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;

            // モバイルデバイスのUser-Agentパターン
            const mobileRegex = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile|tablet/i;

            // タッチデバイスかつ小さい画面の場合もモバイルとみなす
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            const isSmallScreen = window.innerWidth <= 1024;

            return mobileRegex.test(userAgent) || (isTouchDevice && isSmallScreen);
        }

        // サブメニューの開閉
        function toggleSubmenu() {
            submenuOpen = !submenuOpen;
            const submenuPopup = document.getElementById('submenu-popup');
            if (submenuOpen) {
                submenuPopup.classList.add('visible');
            } else {
                submenuPopup.classList.remove('visible');
            }
        }

        // サブメニューボタンの表示/非表示を更新
        function updateSubmenuVisibility() {
            const submenuButton = document.getElementById('submenu-open-button');

            if (viewMode !== 'normal') {
                // シームレスモード時はサブメニューボタンを表示
                submenuButton.classList.add('visible');
            } else {
                // 通常モード時はサブメニューボタンを非表示
                submenuButton.classList.remove('visible');
                // サブメニューを閉じる
                if (submenuOpen) {
                    toggleSubmenu();
                }
            }
        }

        // ズームレベルを設定
        function setZoomLevel(level) {
            if (zoomLevel === level) {
                return; // 既に同じレベルの場合は何もしない
            }

            const seamlessContainer = document.getElementById('seamless-container');
            const verticalContainer = document.getElementById('vertical-container');

            // ズームレベルを更新
            zoomLevel = level;

            // ボタンの状態を更新
            const zoomButtons = document.querySelectorAll('#submenu-zoom-section .submenu-button');
            zoomButtons.forEach(button => {
                button.classList.remove('active');
            });

            if (level === 0.5) {
                zoomButtons[0].classList.add('active'); // 縮小
                seamlessContainer.classList.add('zoomed');
                verticalContainer.classList.add('zoomed');
                console.log('縮小表示を有効化しました (0.5倍)');
            } else if (level === 1) {
                zoomButtons[1].classList.add('active'); // 標準
                seamlessContainer.classList.remove('zoomed');
                verticalContainer.classList.remove('zoomed');
                console.log('標準表示に設定しました (1倍)');
            } else if (level === 2) {
                zoomButtons[2].classList.add('active'); // 拡大
                seamlessContainer.classList.add('zoomed');
                verticalContainer.classList.add('zoomed');
                console.log('拡大表示を有効化しました (2倍)');
            }

            // 現在のモードに応じて再描画
            redrawZoomLevel();
        }

        // 縦読みモードに切り替え
        function switchToVertical() {
            if (seamlessDirection === 'vertical') {
                return; // 既に縦読みモードの場合は何もしない
            }

            // toggleDirection() を呼び出して切り替え
            toggleDirection();
        }

        // 横読みモードに切り替え
        function switchToHorizontal() {
            if (seamlessDirection === 'horizontal') {
                return; // 既に横読みモードの場合は何もしない
            }

            // toggleDirection() を呼び出して切り替え
            toggleDirection();
        }

        // 読み方向ボタンの状態を更新
        function updateDirectionButtons() {
            const verticalButton = document.getElementById('submenu-vertical-button');
            const horizontalButton = document.getElementById('submenu-horizontal-button');

            if (seamlessDirection === 'vertical') {
                verticalButton.classList.add('active');
                horizontalButton.classList.remove('active');
            } else {
                verticalButton.classList.remove('active');
                horizontalButton.classList.add('active');
            }
        }

        // シームレスモードに切り替え
        function switchToSeamlessMode() {
            if (viewMode !== 'normal') {
                return; // 既にシームレスモードの場合は何もしない
            }

            // UI要素のタイマーをリセット
            clearTimeout(uiControlsTimeout);
            uiControlsTimeout = setTimeout(() => {
                if (!isMouseOverUIControls) {
                    hideUIControls();
                }
            }, UI_CONTROLS_HIDE_DELAY);

            // シームレスモードに切り替え（画面サイズに応じて初期モードを決定）
            const landscape = isLandscape();
            seamlessDirection = landscape ? 'horizontal' : 'vertical';
            viewMode = landscape ? 'seamless-horizontal' : 'seamless-vertical';

            document.getElementById('normal-mode-content').style.display = 'none';

            // 自動再生ボタンを表示（左下固定）
            document.getElementById('autoplay-button-fixed').classList.add('visible');

            // サブメニューボタンを表示
            updateSubmenuVisibility();

            // 画面の向きに応じて初期化
            if (landscape) {
                // 横長 → 横読みモード
                document.getElementById('seamless-container').classList.add('active');
                document.getElementById('vertical-container').classList.remove('active');
                initSeamlessMode();
                console.log('画面が横長のため、横読みモードで開始');
            } else {
                // 縦長 → 縦読みモード
                document.getElementById('seamless-container').classList.remove('active');
                document.getElementById('vertical-container').classList.add('active');
                initVerticalMode();
                console.log('画面が縦長のため、縦読みモードで開始');
            }

            // 読み方向ボタンの状態を更新
            updateDirectionButtons();

            // モード切り替えボタンの状態を更新
            updateModeSwitchButtons();
        }

        // 見開きモードに切り替え
        function switchToNormalMode() {
            if (viewMode === 'normal') {
                return; // 既に見開きモードの場合は何もしない
            }

            // UI要素のタイマーをリセット
            clearTimeout(uiControlsTimeout);
            uiControlsTimeout = setTimeout(() => {
                if (!isMouseOverUIControls) {
                    hideUIControls();
                }
            }, UI_CONTROLS_HIDE_DELAY);

            // 通常モードに切り替え
            viewMode = 'normal';
            document.getElementById('seamless-container').classList.remove('active');
            document.getElementById('vertical-container').classList.remove('active');
            document.getElementById('normal-mode-content').style.display = 'block';

            // 自動再生を停止して非表示
            if (autoplayEnabled) {
                toggleAutoplay();
            }
            // ズームレベルを標準に戻す
            if (zoomLevel !== 1) {
                setZoomLevel(1);
            }

            // 自動再生ボタンを非表示
            document.getElementById('autoplay-button-fixed').classList.remove('visible');

            // サブメニューボタンを非表示
            updateSubmenuVisibility();

            // 通常モードを再描画
            if (Module.ccall) {
                Module.ccall('refresh', null, [], []);
            }

            // モード切り替えボタンの状態を更新
            updateModeSwitchButtons();
        }

        // モード切り替えボタンの状態を更新
        function updateModeSwitchButtons() {
            const seamlessButton = document.getElementById('seamless-mode-button');
            const normalButton = document.getElementById('normal-mode-button');
            const seamlessIcon = document.getElementById('seamless-mode-icon');
            const normalIcon = document.getElementById('normal-mode-icon');

            if (viewMode === 'normal') {
                // 見開きモード時
                seamlessButton.classList.remove('inactive');
                seamlessButton.onclick = switchToSeamlessMode;
                seamlessIcon.src = 'public/images/button_seamless_off.png'; // active（押せる）

                normalButton.classList.add('inactive');
                normalButton.onclick = null;
                normalIcon.src = 'public/images/button_mihiraki_on.png'; // inactive（押せない）
            } else {
                // シームレスモード時
                seamlessButton.classList.add('inactive');
                seamlessButton.onclick = null;
                seamlessIcon.src = 'public/images/button_seamless_on.png'; // inactive（押せない）

                normalButton.classList.remove('inactive');
                normalButton.onclick = switchToNormalMode;
                normalIcon.src = 'public/images/button_mihiraki_off.png'; // active（押せる）
            }
        }

        // 横読み・縦読み切り替え
        function toggleDirection() {
            // 自動再生中の場合は停止
            if (autoplayEnabled) {
                toggleAutoplay();
            }

            if (seamlessDirection === 'horizontal') {
                // 縦読みに切り替え
                seamlessDirection = 'vertical';
                viewMode = 'seamless-vertical';
                document.getElementById('seamless-container').classList.remove('active');
                document.getElementById('vertical-container').classList.add('active');

                // 縦読みモードを初期化
                initVerticalMode();
            } else {
                // 横読みに切り替え
                seamlessDirection = 'horizontal';
                viewMode = 'seamless-horizontal';
                document.getElementById('seamless-container').classList.add('active');
                document.getElementById('vertical-container').classList.remove('active');

                // 横読みモードを初期化
                initSeamlessMode();
            }

            // 読み方向ボタンの状態を更新
            updateDirectionButtons();
        }

        // シームレスモード（横読み）の初期化
        function initSeamlessMode() {
            console.log('Initializing seamless horizontal mode...');
            const scrollContainer = document.getElementById('seamless-scroll');
            scrollContainer.innerHTML = ''; // クリア
            seamlessPages = [];

            // 右開きのため、ページを逆順で配置（20, 19, 18, ... 2, 1）
            for (let i = 20; i >= 1 && i <= MAX_PAGES; i--) {
                const canvas = createPageCanvas(i);
                scrollContainer.appendChild(canvas);
            }

            // スクロールイベントを設定
            const seamlessContainer = document.getElementById('seamless-container');
            seamlessContainer.addEventListener('scroll', onSeamlessScroll);

            // ドラッグスクロールを設定
            setupDragScroll(seamlessContainer);

            // 初期スクロール位置を一番右端（1ページ目）に設定
            setTimeout(() => {
                seamlessContainer.scrollLeft = seamlessContainer.scrollWidth - seamlessContainer.clientWidth;
                renderVisiblePages();
            }, 100);
        }

        // 縦読みモードの初期化
        function initVerticalMode() {
            console.log('Initializing vertical mode...');
            const scrollContainer = document.getElementById('vertical-scroll');
            scrollContainer.innerHTML = ''; // クリア
            verticalPages = [];

            // 縦に配置（1, 2, 3, ... 20）
            for (let i = 1; i <= 20 && i <= MAX_PAGES; i++) {
                const canvas = createVerticalPageCanvas(i);
                scrollContainer.appendChild(canvas);
            }

            // スクロールイベントを設定
            const verticalContainer = document.getElementById('vertical-container');
            verticalContainer.addEventListener('scroll', onVerticalScroll);

            // ドラッグスクロールを設定（縦方向）
            setupVerticalDragScroll(verticalContainer);

            // 初期スクロール位置を一番上（1ページ目）に設定
            setTimeout(() => {
                verticalContainer.scrollTop = 0;
                renderVerticalVisiblePages();
            }, 100);
        }

        // ドラッグでスクロールする機能（右から左へのスクロール）
        function setupDragScroll(container) {
            let isDragging = false;
            let startX = 0;
            let startY = 0;
            let scrollLeft = 0;
            let scrollTop = 0;
            let autoplayPausedByDrag = false;

            container.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.pageX - container.offsetLeft;
                startY = e.pageY - container.offsetTop;
                scrollLeft = container.scrollLeft;
                scrollTop = container.scrollTop;
                container.style.cursor = 'grabbing';
                container.style.userSelect = 'none';
                container.style.scrollBehavior = 'auto'; // ドラッグ中はsmoothを無効化

                console.log(`[Horizontal] Drag start - scrollLeft: ${scrollLeft}, scrollTop: ${scrollTop}, zoomLevel: ${zoomLevel}`);

                // 自動再生中の場合は一時停止
                if (autoplayEnabled) {
                    autoplayPausedByDrag = true;
                    if (autoplayInterval) {
                        clearInterval(autoplayInterval);
                        autoplayInterval = null;
                    }
                }
            });

            container.addEventListener('mouseleave', () => {
                isDragging = false;
                container.style.cursor = 'grab';
                container.style.scrollBehavior = 'smooth'; // smoothに戻す
            });

            container.addEventListener('mouseup', () => {
                isDragging = false;
                container.style.cursor = 'grab';
                container.style.scrollBehavior = 'smooth'; // smoothに戻す

                // ドラッグで一時停止していた場合は再開
                if (autoplayPausedByDrag && autoplayEnabled) {
                    autoplayPausedByDrag = false;
                    startHorizontalAutoplay(container);
                }
            });

            container.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.pageX - container.offsetLeft;
                const y = e.pageY - container.offsetTop;
                const walkX = (x - startX) * 2; // スクロール速度を調整
                const walkY = (y - startY) * 2;

                // 左にドラッグでページが増える、右にドラッグでページが減る
                const newScrollLeft = scrollLeft - walkX;
                container.scrollLeft = newScrollLeft;
                console.log(`[Horizontal] Setting scrollLeft to ${newScrollLeft} (original: ${scrollLeft}, walkX: ${walkX})`);

                // 拡大・縮小表示時は縦方向にもスクロール
                if (zoomLevel !== 1) {
                    const newScrollTop = scrollTop - walkY;
                    container.scrollTop = newScrollTop;
                    console.log(`[Horizontal] Setting scrollTop to ${newScrollTop} (original: ${scrollTop}, walkY: ${walkY})`);
                }
            });

            // タッチイベント（モバイル対応）
            container.addEventListener('touchstart', (e) => {
                isDragging = true;
                startX = e.touches[0].pageX - container.offsetLeft;
                startY = e.touches[0].pageY - container.offsetTop;
                scrollLeft = container.scrollLeft;
                scrollTop = container.scrollTop;

                // 自動再生中の場合は一時停止
                if (autoplayEnabled) {
                    autoplayPausedByDrag = true;
                    if (autoplayInterval) {
                        clearInterval(autoplayInterval);
                        autoplayInterval = null;
                    }
                }
            });

            container.addEventListener('touchend', () => {
                isDragging = false;

                // ドラッグで一時停止していた場合は再開
                if (autoplayPausedByDrag && autoplayEnabled) {
                    autoplayPausedByDrag = false;
                    startHorizontalAutoplay(container);
                }
            });

            container.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const x = e.touches[0].pageX - container.offsetLeft;
                const y = e.touches[0].pageY - container.offsetTop;
                const walkX = (x - startX) * 2;
                const walkY = (y - startY) * 2;

                // 左にドラッグでページが増える、右にドラッグでページが減る
                container.scrollLeft = scrollLeft - walkX;

                // 拡大・縮小表示時は縦方向にもスクロール
                if (zoomLevel !== 1) {
                    container.scrollTop = scrollTop - walkY;
                }
            });

            // カーソルスタイルを設定
            container.style.cursor = 'grab';
        }

        // ページ用のCanvasを作成（横読み用）
        function createPageCanvas(pageNum) {
            // 既に存在する場合は既存のものを返す
            const existing = document.getElementById(`page-canvas-${pageNum}`);
            if (existing) {
                return existing;
            }

            const canvas = document.createElement('canvas');
            canvas.id = `page-canvas-${pageNum}`;
            canvas.className = 'page-canvas';
            canvas.dataset.pageNum = pageNum;
            canvas.dataset.loaded = 'false';

            // デバイスピクセル比を取得
            const dpr = window.devicePixelRatio || 1;

            // 一般的なマンガのアスペクト比（2:3）で初期サイズを設定（論理サイズ）
            // 表示倍率を適用
            const scale = zoomLevel;
            const canvasHeight = window.innerHeight * scale;
            const canvasWidth = Math.floor(canvasHeight * (2 / 3));

            // 描画バッファサイズは物理ピクセル（高DPI対応）
            canvas.width = Math.floor(canvasWidth * dpr);
            canvas.height = Math.floor(canvasHeight * dpr);
            // CSSサイズは論理ピクセル
            canvas.style.width = canvasWidth + 'px';
            canvas.style.height = canvasHeight + 'px';

            seamlessPages.push(pageNum);

            console.log(`Created horizontal canvas for page ${pageNum}, logical: ${canvasWidth}x${canvasHeight}, physical: ${canvas.width}x${canvas.height}, dpr: ${dpr}, scale: ${scale}`);

            return canvas;
        }

        // 縦読み用のCanvasを作成
        function createVerticalPageCanvas(pageNum) {
            // 既に存在する場合は既存のものを返す
            const existing = document.getElementById(`vertical-canvas-${pageNum}`);
            if (existing) {
                return existing;
            }

            const canvas = document.createElement('canvas');
            canvas.id = `vertical-canvas-${pageNum}`;
            canvas.className = 'vertical-page-canvas';
            canvas.dataset.pageNum = pageNum;
            canvas.dataset.loaded = 'false';

            // デバイスピクセル比を取得
            const dpr = window.devicePixelRatio || 1;

            // 一般的なマンガのアスペクト比（2:3）で初期サイズを設定（論理サイズ）
            // 表示倍率を適用
            const scale = zoomLevel;
            const canvasWidth = window.innerWidth * scale;
            const canvasHeight = Math.floor(canvasWidth * (3 / 2));

            // 描画バッファサイズは物理ピクセル（高DPI対応）
            canvas.width = Math.floor(canvasWidth * dpr);
            canvas.height = Math.floor(canvasHeight * dpr);
            // CSSサイズは論理ピクセル
            canvas.style.width = canvasWidth + 'px';
            canvas.style.height = canvasHeight + 'px';

            verticalPages.push(pageNum);

            console.log(`Created vertical canvas for page ${pageNum}, logical: ${canvasWidth}x${canvasHeight}, physical: ${canvas.width}x${canvas.height}, dpr: ${dpr}, scale: ${scale}`);

            return canvas;
        }

        // シームレスモード（横読み）のスクロール処理
        let scrollTimeout;
        function onSeamlessScroll() {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                loadMorePagesIfNeeded();
                renderVisiblePages();
            }, 100);
        }

        // 縦読みモードのスクロール処理
        let verticalScrollTimeout;
        function onVerticalScroll() {
            clearTimeout(verticalScrollTimeout);
            verticalScrollTimeout = setTimeout(() => {
                loadMoreVerticalPagesIfNeeded();
                renderVerticalVisiblePages();
            }, 100);
        }

        // 必要に応じてさらにページを読み込む
        function loadMorePagesIfNeeded() {
            if (!Module.ccall) return;

            const container = document.getElementById('seamless-container');
            const containerRect = container.getBoundingClientRect();

            // 現在表示されている最も小さいページ番号を見つける
            const allCanvases = Array.from(document.querySelectorAll('.page-canvas'));
            let minVisiblePage = MAX_PAGES;

            allCanvases.forEach(canvas => {
                const rect = canvas.getBoundingClientRect();
                // 表示範囲内または左側に近い場合
                if (rect.right > containerRect.left - containerRect.width) {
                    const pageNum = parseInt(canvas.dataset.pageNum);
                    if (pageNum < minVisiblePage) {
                        minVisiblePage = pageNum;
                    }
                }
            });

            // 表示中のページから先のページを追加で作成
            const nextPageStart = Math.min(...seamlessPages) - 1;
            const pagesToAdd = [];

            // 次の10ページ分のCanvasを作成（まだ存在しない場合）
            for (let i = nextPageStart; i > Math.max(1, nextPageStart - 10); i--) {
                if (i >= 1 && !document.getElementById(`page-canvas-${i}`)) {
                    pagesToAdd.push(i);
                }
            }

            // 降順でページを追加（大きい番号から小さい番号へ）
            pagesToAdd.sort((a, b) => b - a);
            pagesToAdd.forEach(pageNum => {
                const canvas = createPageCanvas(pageNum);
                // 先頭に追加（降順なので）
                const scrollContainer = document.getElementById('seamless-scroll');
                const firstChild = scrollContainer.firstChild;
                if (firstChild) {
                    scrollContainer.insertBefore(canvas, firstChild);
                } else {
                    scrollContainer.appendChild(canvas);
                }
                console.log(`Added canvas for page ${pageNum}`);

                // ページをキャッシュに読み込む
                Module.ccall('loadPageToCache', null, ['number'], [pageNum]);
            });
        }

        // 表示範囲内のページを描画
        function renderVisiblePages() {
            if (!Module.ccall) {
                console.log('Module.ccall not ready');
                return;
            }

            const container = document.getElementById('seamless-container');
            const scrollLeft = container.scrollLeft;
            const containerWidth = container.clientWidth;

            seamlessPages.forEach(pageNum => {
                const canvas = document.getElementById(`page-canvas-${pageNum}`);
                if (!canvas) return;

                const rect = canvas.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();

                // Canvasが表示範囲内にあるか確認（余裕を持たせる）
                const isVisible = rect.left < containerRect.right + containerWidth &&
                                rect.right > containerRect.left - containerWidth;

                if (isVisible && canvas.dataset.loaded === 'false') {
                    // ページを読み込んで描画
                    console.log(`Loading and rendering page ${pageNum} in seamless mode`);
                    canvas.dataset.loaded = 'loading';

                    // まずページをキャッシュに読み込む
                    Module.ccall('loadPageToCache', null, ['number'], [pageNum]);

                    // ページの読み込みを待ってから描画を試みる（リトライ機能付き）
                    let retryCount = 0;
                    const maxRetries = 10;
                    const tryRender = () => {
                        try {
                            Module.ccall('renderSinglePage', null, ['number', 'string'],
                                       [pageNum, `page-canvas-${pageNum}`]);
                            canvas.dataset.loaded = 'true';
                            console.log(`Successfully rendered page ${pageNum}`);
                        } catch (e) {
                            retryCount++;
                            if (retryCount < maxRetries) {
                                setTimeout(tryRender, 300);
                            } else {
                                console.error(`Gave up rendering page ${pageNum} after ${maxRetries} attempts`);
                                canvas.dataset.loaded = 'false';
                            }
                        }
                    };

                    setTimeout(tryRender, 200);
                }
            });
        }


        // 縦読みモード用：必要に応じてさらにページを読み込む
        function loadMoreVerticalPagesIfNeeded() {
            if (!Module.ccall) return;

            const container = document.getElementById('vertical-container');
            const containerHeight = container.clientHeight;
            const scrollTop = container.scrollTop;
            const scrollHeight = container.scrollHeight;

            // 下端に近づいたら次のページを追加
            if (scrollTop + containerHeight > scrollHeight - containerHeight * 2) {
                const nextPageStart = Math.max(...verticalPages) + 1;
                const pagesToAdd = [];

                // 次の10ページ分のCanvasを作成
                for (let i = nextPageStart; i < nextPageStart + 10 && i <= MAX_PAGES; i++) {
                    if (!document.getElementById(`vertical-canvas-${i}`)) {
                        pagesToAdd.push(i);
                    }
                }

                pagesToAdd.forEach(pageNum => {
                    const canvas = createVerticalPageCanvas(pageNum);
                    document.getElementById('vertical-scroll').appendChild(canvas);
                    console.log(`Added vertical canvas for page ${pageNum}`);

                    // ページをキャッシュに読み込む
                    Module.ccall('loadPageToCache', null, ['number'], [pageNum]);
                });
            }
        }

        // 縦読みモード：表示範囲内のページを描画
        function renderVerticalVisiblePages() {
            if (!Module.ccall) {
                console.log('Module.ccall not ready');
                return;
            }

            const container = document.getElementById('vertical-container');
            const containerRect = container.getBoundingClientRect();
            const containerHeight = container.clientHeight;

            verticalPages.forEach(pageNum => {
                const canvas = document.getElementById(`vertical-canvas-${pageNum}`);
                if (!canvas) return;

                const rect = canvas.getBoundingClientRect();

                // Canvasが表示範囲内にあるか確認（余裕を持たせる）
                const isVisible = rect.top < containerRect.bottom + containerHeight &&
                                rect.bottom > containerRect.top - containerHeight;

                if (isVisible && canvas.dataset.loaded === 'false') {
                    // ページを読み込んで描画
                    console.log(`Loading and rendering vertical page ${pageNum}`);
                    canvas.dataset.loaded = 'loading';

                    // まずページをキャッシュに読み込む
                    Module.ccall('loadPageToCache', null, ['number'], [pageNum]);

                    // ページの読み込みを待ってから描画を試みる
                    let retryCount = 0;
                    const maxRetries = 10;
                    const tryRender = () => {
                        try {
                            Module.ccall('renderSinglePage', null, ['number', 'string'],
                                       [pageNum, `vertical-canvas-${pageNum}`]);
                            canvas.dataset.loaded = 'true';
                            console.log(`Successfully rendered vertical page ${pageNum}`);
                        } catch (e) {
                            retryCount++;
                            if (retryCount < maxRetries) {
                                setTimeout(tryRender, 300);
                            } else {
                                console.error(`Gave up rendering vertical page ${pageNum} after ${maxRetries} attempts`);
                                canvas.dataset.loaded = 'false';
                            }
                        }
                    };

                    setTimeout(tryRender, 200);
                }
            });
        }

        // 縦ドラッグでスクロールする機能
        function setupVerticalDragScroll(container) {
            let isDragging = false;
            let startX = 0;
            let startY = 0;
            let scrollLeft = 0;
            let scrollTop = 0;
            let autoplayPausedByDrag = false;

            container.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.pageX - container.offsetLeft;
                startY = e.pageY - container.offsetTop;
                scrollLeft = container.scrollLeft;
                scrollTop = container.scrollTop;
                container.style.cursor = 'grabbing';
                container.style.userSelect = 'none';
                container.style.scrollBehavior = 'auto'; // ドラッグ中はsmoothを無効化

                console.log(`[Vertical] Drag start - scrollLeft: ${scrollLeft}, scrollTop: ${scrollTop}, zoomLevel: ${zoomLevel}`);

                // 自動再生中の場合は一時停止
                if (autoplayEnabled) {
                    autoplayPausedByDrag = true;
                    if (autoplayInterval) {
                        clearInterval(autoplayInterval);
                        autoplayInterval = null;
                    }
                }
            });

            container.addEventListener('mouseleave', () => {
                isDragging = false;
                container.style.cursor = 'grab';
                container.style.scrollBehavior = 'smooth'; // smoothに戻す
            });

            container.addEventListener('mouseup', () => {
                isDragging = false;
                container.style.cursor = 'grab';
                container.style.scrollBehavior = 'smooth'; // smoothに戻す

                // ドラッグで一時停止していた場合は再開
                if (autoplayPausedByDrag && autoplayEnabled) {
                    autoplayPausedByDrag = false;
                    startVerticalAutoplay(container);
                }
            });

            container.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.pageX - container.offsetLeft;
                const y = e.pageY - container.offsetTop;
                const walkX = (x - startX) * 2; // スクロール速度を調整
                const walkY = (y - startY) * 2;

                const newScrollTop = scrollTop - walkY;
                container.scrollTop = newScrollTop;
                console.log(`[Vertical] Setting scrollTop to ${newScrollTop} (original: ${scrollTop}, walkY: ${walkY})`);

                // 拡大・縮小表示時は横方向にもスクロール
                if (zoomLevel !== 1) {
                    const newScrollLeft = scrollLeft - walkX;
                    container.scrollLeft = newScrollLeft;
                    console.log(`[Vertical] Setting scrollLeft to ${newScrollLeft} (original: ${scrollLeft}, walkX: ${walkX})`);
                }
            });

            // タッチイベント（モバイル対応）
            container.addEventListener('touchstart', (e) => {
                isDragging = true;
                startX = e.touches[0].pageX - container.offsetLeft;
                startY = e.touches[0].pageY - container.offsetTop;
                scrollLeft = container.scrollLeft;
                scrollTop = container.scrollTop;
                container.style.scrollBehavior = 'auto'; // ドラッグ中はsmoothを無効化

                // 自動再生中の場合は一時停止
                if (autoplayEnabled) {
                    autoplayPausedByDrag = true;
                    if (autoplayInterval) {
                        clearInterval(autoplayInterval);
                        autoplayInterval = null;
                    }
                }
            });

            container.addEventListener('touchend', () => {
                isDragging = false;
                container.style.scrollBehavior = 'smooth'; // smoothに戻す

                // ドラッグで一時停止していた場合は再開
                if (autoplayPausedByDrag && autoplayEnabled) {
                    autoplayPausedByDrag = false;
                    startVerticalAutoplay(container);
                }
            });

            container.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const x = e.touches[0].pageX - container.offsetLeft;
                const y = e.touches[0].pageY - container.offsetTop;
                const walkX = (x - startX) * 2;
                const walkY = (y - startY) * 2;

                const newScrollTop = scrollTop - walkY;
                container.scrollTop = newScrollTop;

                // 拡大・縮小表示時は横方向にもスクロール
                if (zoomLevel !== 1) {
                    const newScrollLeft = scrollLeft - walkX;
                    container.scrollLeft = newScrollLeft;
                }
            });

            // カーソルスタイルを設定
            container.style.cursor = 'grab';
        }

        // 自動再生の切り替え
        function toggleAutoplay() {
            // UI要素のタイマーをリセット
            clearTimeout(uiControlsTimeout);
            uiControlsTimeout = setTimeout(() => {
                if (!isMouseOverUIControls) {
                    hideUIControls();
                }
            }, UI_CONTROLS_HIDE_DELAY);

            const button = document.getElementById('autoplay-button-fixed');
            const textSpan = button.querySelector('span');

            if (!autoplayEnabled) {
                // 自動再生を開始
                autoplayEnabled = true;
                textSpan.textContent = '再生中';
                button.classList.add('playing');

                if (seamlessDirection === 'horizontal') {
                    const container = document.getElementById('seamless-container');
                    startHorizontalAutoplay(container);
                } else {
                    const container = document.getElementById('vertical-container');
                    startVerticalAutoplay(container);
                }

                console.log('自動再生を開始しました');
            } else {
                // 自動再生を停止
                autoplayEnabled = false;
                textSpan.textContent = '自動再生';
                button.classList.remove('playing');

                if (autoplayInterval) {
                    clearInterval(autoplayInterval);
                    autoplayInterval = null;
                }

                console.log('自動再生を停止しました');
            }
        }

        // 横読み自動再生を開始
        function startHorizontalAutoplay(container) {
            let frameCount = 0;
            autoplayInterval = setInterval(() => {
                if (container.scrollLeft > 0) {
                    // 左にスクロール（ページを読み進める）
                    container.scrollLeft -= AUTOPLAY_SPEED;

                    // 10フレームごとに新しいページを読み込む
                    frameCount++;
                    if (frameCount % 10 === 0) {
                        loadMorePagesIfNeeded();
                        renderVisiblePages();
                    }
                } else {
                    // 最後のページに到達したら自動再生を停止
                    console.log('最後のページに到達しました');
                    toggleAutoplay();
                }
            }, 1000 / AUTOPLAY_FPS);
        }

        // 縦読み自動再生を開始
        function startVerticalAutoplay(container) {
            let frameCount = 0;
            autoplayInterval = setInterval(() => {
                const maxScroll = container.scrollHeight - container.clientHeight;
                if (container.scrollTop < maxScroll) {
                    // 下にスクロール（ページを読み進める）
                    container.scrollTop += AUTOPLAY_SPEED;

                    // 10フレームごとに新しいページを読み込む
                    frameCount++;
                    if (frameCount % 10 === 0) {
                        loadMoreVerticalPagesIfNeeded();
                        renderVerticalVisiblePages();
                    }
                } else {
                    // 最後のページに到達したら自動再生を停止
                    console.log('最後のページに到達しました');
                    toggleAutoplay();
                }
            }, 1000 / AUTOPLAY_FPS);
        }

        // ズームレベル変更時の再描画処理
        function redrawZoomLevel() {
            if (seamlessDirection === 'horizontal') {
                // 横読みモードの場合：全Canvasをクリアして再作成
                const scrollContainer = document.getElementById('seamless-scroll');
                const currentScrollLeft = document.getElementById('seamless-container').scrollLeft;
                const previousZoomLevel = currentScrollLeft > 0 ?
                    (zoomLevel === 2 ? 1 : (zoomLevel === 0.5 ? 1 : zoomLevel)) : 1;

                // すべてのページの読み込み状態をリセット
                seamlessPages.forEach(pageNum => {
                    const canvas = document.getElementById(`page-canvas-${pageNum}`);
                    if (canvas) {
                        canvas.dataset.loaded = 'false';
                    }
                });

                // Canvasのサイズを再計算して再描画
                recreateHorizontalCanvases();

                // スクロール位置を調整（拡大率に応じて）
                setTimeout(() => {
                    const container = document.getElementById('seamless-container');
                    const scale = zoomLevel / previousZoomLevel;
                    container.scrollLeft = currentScrollLeft * scale;
                    renderVisiblePages();
                }, 100);
            } else {
                // 縦読みモードの場合：全Canvasをクリアして再作成
                const currentScrollTop = document.getElementById('vertical-container').scrollTop;
                const previousZoomLevel = currentScrollTop > 0 ?
                    (zoomLevel === 2 ? 1 : (zoomLevel === 0.5 ? 1 : zoomLevel)) : 1;

                // すべてのページの読み込み状態をリセット
                verticalPages.forEach(pageNum => {
                    const canvas = document.getElementById(`vertical-canvas-${pageNum}`);
                    if (canvas) {
                        canvas.dataset.loaded = 'false';
                    }
                });

                // Canvasのサイズを再計算して再描画
                recreateVerticalCanvases();

                // スクロール位置を調整
                setTimeout(() => {
                    const container = document.getElementById('vertical-container');
                    const scale = zoomLevel / previousZoomLevel;
                    container.scrollTop = currentScrollTop * scale;
                    renderVerticalVisiblePages();
                }, 100);
            }
        }

        // 横読みモードのCanvasを再作成
        function recreateHorizontalCanvases() {
            const dpr = window.devicePixelRatio || 1;
            const pages = [...seamlessPages];
            pages.forEach(pageNum => {
                const canvas = document.getElementById(`page-canvas-${pageNum}`);
                if (canvas) {
                    // Canvasのサイズを再計算（論理サイズ）
                    const scale = zoomLevel;
                    const canvasHeight = window.innerHeight * scale;
                    const canvasWidth = Math.floor(canvasHeight * (2 / 3));

                    // 描画バッファサイズは物理ピクセル（高DPI対応）
                    canvas.width = Math.floor(canvasWidth * dpr);
                    canvas.height = Math.floor(canvasHeight * dpr);
                    // CSSサイズは論理ピクセル
                    canvas.style.width = canvasWidth + 'px';
                    canvas.style.height = canvasHeight + 'px';
                    canvas.dataset.loaded = 'false';
                }
            });
        }

        // 縦読みモードのCanvasを再作成
        function recreateVerticalCanvases() {
            const dpr = window.devicePixelRatio || 1;
            const pages = [...verticalPages];
            pages.forEach(pageNum => {
                const canvas = document.getElementById(`vertical-canvas-${pageNum}`);
                if (canvas) {
                    // Canvasのサイズを再計算（論理サイズ）
                    const scale = zoomLevel;
                    const canvasWidth = window.innerWidth * scale;
                    const canvasHeight = Math.floor(canvasWidth * (3 / 2));

                    // 描画バッファサイズは物理ピクセル（高DPI対応）
                    canvas.width = Math.floor(canvasWidth * dpr);
                    canvas.height = Math.floor(canvasHeight * dpr);
                    // CSSサイズは論理ピクセル
                    canvas.style.width = canvasWidth + 'px';
                    canvas.style.height = canvasHeight + 'px';
                    canvas.dataset.loaded = 'false';
                }
            });
        }

        // 全画面表示の切り替え
        function toggleFullscreen() {
            // UI要素のタイマーをリセット
            clearTimeout(uiControlsTimeout);
            uiControlsTimeout = setTimeout(() => {
                if (!isMouseOverUIControls) {
                    hideUIControls();
                }
            }, UI_CONTROLS_HIDE_DELAY);

            const container = document.getElementById('container');

            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                // 全画面モードに入る
                if (container.requestFullscreen) {
                    container.requestFullscreen().catch(err => {
                        console.error('全画面表示に失敗:', err);
                    });
                } else if (container.webkitRequestFullscreen) {
                    // Safari対応
                    container.webkitRequestFullscreen();
                } else if (container.msRequestFullscreen) {
                    // IE11対応
                    container.msRequestFullscreen();
                }
            } else {
                // 全画面モードから抜ける
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }

        // 全画面表示アイコンを更新
        function updateFullscreenIcon() {
            const icon = document.getElementById('fullscreen-icon');
            if (document.fullscreenElement || document.webkitFullscreenElement) {
                // 全画面表示中
                icon.src = 'public/images/fullscreen_cancel.png';
            } else {
                // 通常表示
                icon.src = 'public/images/fullscreen.png';
            }
        }

        // UI要素の自動表示/非表示管理
        let uiControlsTimeout;
        let isMouseOverUIControls = false;
        const UI_CONTROLS_HIDE_DELAY = 3000; // 3秒後に自動で非表示

        // UI要素を表示する関数
        function showUIControls() {
            const submenuButton = document.getElementById('submenu-open-button');
            const autoplayButton = document.getElementById('autoplay-button-fixed');
            const modeSwitchContainer = document.getElementById('mode-switch-container');
            const fullscreenButton = document.getElementById('fullscreen-button-fixed');

            // 表示するUI要素にshowクラスを追加
            if (viewMode !== 'normal' && submenuButton.classList.contains('visible')) {
                submenuButton.classList.add('show');
            }

            if (viewMode !== 'normal' && autoplayButton.classList.contains('visible')) {
                autoplayButton.classList.add('show');
            }

            modeSwitchContainer.classList.add('show');

            if (!isMobileDevice()) {
                fullscreenButton.classList.add('show');
            }

            // 既存のタイマーをクリア
            clearTimeout(uiControlsTimeout);

            // 3秒後に自動で非表示にする（UI要素上にマウスがない場合）
            uiControlsTimeout = setTimeout(() => {
                if (!isMouseOverUIControls) {
                    hideUIControls();
                }
            }, UI_CONTROLS_HIDE_DELAY);
        }

        // UI要素を非表示にする関数
        function hideUIControls() {
            if (!isMouseOverUIControls) {
                const submenuButton = document.getElementById('submenu-open-button');
                const autoplayButton = document.getElementById('autoplay-button-fixed');
                const modeSwitchContainer = document.getElementById('mode-switch-container');
                const fullscreenButton = document.getElementById('fullscreen-button-fixed');

                submenuButton.classList.remove('show');
                autoplayButton.classList.remove('show');
                modeSwitchContainer.classList.remove('show');
                fullscreenButton.classList.remove('show');
            }
        }

        // ナビゲーションバーの自動表示/非表示管理
        let navBarTimeout;
        let isMouseOverNavBar = false;
        const NAV_BAR_ZONE_HEIGHT = 100; // 画面下部から何ピクセルの範囲で表示するか
        const NAV_BAR_HIDE_DELAY = 3000; // 3秒後に自動で非表示

        // 初期状態で非表示
        const navBar = document.getElementById('nav-bar');
        navBar.classList.add('hide');

        // ナビゲーションバーを表示する関数
        function showNavBar() {
            navBar.classList.remove('hide');
            navBar.classList.add('show');

            // 既存のタイマーをクリア
            clearTimeout(navBarTimeout);

            // 3秒後に自動で非表示にする（ナビゲーションバー上にマウスがない場合）
            navBarTimeout = setTimeout(() => {
                if (!isMouseOverNavBar) {
                    hideNavBar();
                }
            }, NAV_BAR_HIDE_DELAY);
        }

        // ナビゲーションバーを非表示にする関数
        function hideNavBar() {
            if (!isMouseOverNavBar) {
                navBar.classList.remove('show');
                navBar.classList.add('hide');
            }
        }

        // マウスムーブで画面下部に入ったら表示
        document.addEventListener('mousemove', function(e) {
            const windowHeight = window.innerHeight;
            const mouseY = e.clientY;

            // 画面下部のゾーンに入ったら表示
            if (mouseY > windowHeight - NAV_BAR_ZONE_HEIGHT) {
                showNavBar();
            }
        });

        // 画面上のクリックでUI要素を表示（見開きモード時は左右ボタン以外）
        document.addEventListener('click', function(e) {
            // サブメニュー関連の要素をクリックした場合は何もしない
            const submenuButton = document.getElementById('submenu-open-button');
            const submenuPopup = document.getElementById('submenu-popup');

            if (submenuButton.contains(e.target)) {
                // サブメニューボタンがクリックされた場合は何もしない（toggleSubmenuが処理する）
                // UI要素のタイマーをリセット
                clearTimeout(uiControlsTimeout);
                uiControlsTimeout = setTimeout(() => {
                    if (!isMouseOverUIControls) {
                        hideUIControls();
                    }
                }, UI_CONTROLS_HIDE_DELAY);
                return;
            }

            if (submenuPopup.contains(e.target)) {
                // サブメニュー内をクリックした場合は何もしない
                // UI要素のタイマーをリセット
                clearTimeout(uiControlsTimeout);
                uiControlsTimeout = setTimeout(() => {
                    if (!isMouseOverUIControls) {
                        hideUIControls();
                    }
                }, UI_CONTROLS_HIDE_DELAY);
                return;
            }

            // サブメニューが開いている状態で、外側をクリックした場合は閉じる
            if (submenuOpen) {
                toggleSubmenu();
            }

            // 見開きモード時は左右のページ移動ボタンをクリックした場合は表示しない
            if (viewMode === 'normal') {
                const nextButton = document.getElementById('next-button');
                const prevButton = document.getElementById('prev-button');

                // クリックされた要素がページ移動ボタンかどうか確認
                if (e.target === nextButton || e.target === prevButton) {
                    return; // ボタンがクリックされた場合は何もしない
                }
            }

            // それ以外の場所がクリックされたらUI要素とナビゲーションバーを表示
            showUIControls();
            showNavBar();
        });

        // タッチイベント（モバイル対応）
        document.addEventListener('touchstart', function(e) {
            const submenuButton = document.getElementById('submenu-open-button');
            const submenuPopup = document.getElementById('submenu-popup');
            const touch = e.touches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY);

            // サブメニュー関連をタップした場合はUI要素のタイマーをリセット
            if (submenuButton.contains(target) || submenuPopup.contains(target)) {
                clearTimeout(uiControlsTimeout);
                uiControlsTimeout = setTimeout(() => {
                    if (!isMouseOverUIControls) {
                        hideUIControls();
                    }
                }, UI_CONTROLS_HIDE_DELAY);
                return;
            }

            // 見開きモード時は左右のページ移動ボタンをタップした場合は表示しない
            if (viewMode === 'normal') {
                const nextButton = document.getElementById('next-button');
                const prevButton = document.getElementById('prev-button');

                // タップされた要素がページ移動ボタンかどうか確認
                if (target === nextButton || target === prevButton) {
                    return; // ボタンがタップされた場合は何もしない
                }
            }

            // それ以外の場所がタップされたらUI要素とナビゲーションバーを表示
            showUIControls();
            showNavBar();
        });

        // UI要素にマウスが乗っている間は非表示にしない
        const uiElements = [
            document.getElementById('submenu-open-button'),
            document.getElementById('submenu-popup'),
            document.getElementById('autoplay-button-fixed'),
            document.getElementById('mode-switch-container'),
            document.getElementById('fullscreen-button-fixed')
        ];

        uiElements.forEach(element => {
            if (element) {
                element.addEventListener('mouseenter', function() {
                    isMouseOverUIControls = true;
                    clearTimeout(uiControlsTimeout);
                });

                element.addEventListener('mouseleave', function() {
                    isMouseOverUIControls = false;
                    // マウスが離れたら3秒後に非表示
                    uiControlsTimeout = setTimeout(() => {
                        hideUIControls();
                    }, UI_CONTROLS_HIDE_DELAY);
                });
            }
        });

        // ナビゲーションバーにマウスが乗っている間は非表示にしない
        navBar.addEventListener('mouseenter', function() {
            isMouseOverNavBar = true;
            clearTimeout(navBarTimeout);
        });

        navBar.addEventListener('mouseleave', function() {
            isMouseOverNavBar = false;
            // マウスが離れたら3秒後に非表示
            navBarTimeout = setTimeout(() => {
                hideNavBar();
            }, NAV_BAR_HIDE_DELAY);
        });

        // 全画面モードの変化を検知してアイコンを更新
        document.addEventListener('fullscreenchange', function() {
            updateFullscreenIcon();
            if (document.fullscreenElement) {
                console.log('全画面モードに入りました');
            } else {
                console.log('全画面モードから抜けました');
            }
        });

        // Safari用
        document.addEventListener('webkitfullscreenchange', function() {
            updateFullscreenIcon();
            if (document.webkitFullscreenElement) {
                console.log('全画面モードに入りました (webkit)');
            } else {
                console.log('全画面モードから抜けました (webkit)');
            }
        });

        // キーボードショートカット
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') {
                nextPage();
            } else if (e.key === 'ArrowRight') {
                prevPage();
            } else if (e.key === 'c' || e.key === 'C') {
                showCacheStatus();
            }
        });

        // 右クリックメニューを無効化（画像保存を防ぐ）
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        // ドラッグによる画像保存を防ぐ
        document.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });

        // スクリプトロードのエラーハンドリング
        window.addEventListener('error', function(e) {
            console.error('Script error:', e);
        });

        // ウィンドウリサイズ時に再描画 & モード自動切り替え
        let resizeTimer;
        let previousOrientation = isLandscape(); // 前回の画面の向きを記憶
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                console.log('Window resized, re-rendering...');

                const currentOrientation = isLandscape();

                if (viewMode !== 'normal') {
                    // シームレスモード中で、画面の向きが変わった場合は自動的にモードを切り替え
                    if (currentOrientation !== previousOrientation) {
                        console.log(`画面の向きが変わりました: ${currentOrientation ? '横長' : '縦長'}`);

                        // 自動再生中の場合は一時停止
                        const wasAutoplayEnabled = autoplayEnabled;
                        if (autoplayEnabled) {
                            toggleAutoplay();
                        }

                        if (currentOrientation) {
                            // 横長になった → 横読みモードに切り替え
                            if (seamlessDirection !== 'horizontal') {
                                seamlessDirection = 'horizontal';
                                viewMode = 'seamless-horizontal';
                                document.getElementById('seamless-container').classList.add('active');
                                document.getElementById('vertical-container').classList.remove('active');
                                initSeamlessMode();
                                updateDirectionButtons();
                                console.log('横読みモードに自動切り替え');
                            }
                        } else {
                            // 縦長になった → 縦読みモードに切り替え
                            if (seamlessDirection !== 'vertical') {
                                seamlessDirection = 'vertical';
                                viewMode = 'seamless-vertical';
                                document.getElementById('seamless-container').classList.remove('active');
                                document.getElementById('vertical-container').classList.add('active');
                                initVerticalMode();
                                updateDirectionButtons();
                                console.log('縦読みモードに自動切り替え');
                            }
                        }

                        // 自動再生が有効だった場合は再開
                        if (wasAutoplayEnabled) {
                            setTimeout(() => {
                                toggleAutoplay();
                            }, 500);
                        }

                        previousOrientation = currentOrientation;
                    }
                } else if (viewMode === 'normal') {
                    // 通常モード（見開きモード）の場合
                    if (currentOrientation !== previousOrientation && Module.ccall) {
                        // 画面の向きが変わった場合、1ページ/2ページモードを切り替え
                        const singlePage = !currentOrientation; // 縦長の場合は1ページモード
                        console.log(`通常モード: ${currentOrientation ? '2ページ表示（横長）' : '1ページ表示（縦長）'}に切り替え`);

                        try {
                            Module.ccall('setSinglePageMode', null, ['boolean'], [singlePage]);
                        } catch (e) {
                            console.error('Error in setSinglePageMode:', e);
                        }

                        previousOrientation = currentOrientation;
                    } else if (Module.ccall) {
                        // 画面の向きが変わっていない場合は再描画のみ
                        try {
                            Module.ccall('refresh', null, [], []);
                        } catch (e) {
                            console.error('Error in resize handler:', e);
                        }
                    }
                }
            }, 250);
        });
    </script>

    <script async type="text/javascript" src="build/mukuviewer.js"></script>
</body>
</html>
